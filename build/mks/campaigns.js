define(["jquery.bmsgrid","jquery.highlight","jquery.searchcontrol","text!html/campaigns.html","bms-filters","daterangepicker"],function(e,d,c,b,a,f){return Backbone.View.extend({id:"campaigns_list",tags:"div",events:{"click #addnew_campaign":function(){this.createCampaign()},"keyup #daterange":function(){this.$el.find("#clearcal").show()},"click #clearcal":function(g){this.$el.find("#clearcal").hide();this.$el.find("#daterange").val("");this.findCampaigns(g)},"click #camps_grid .btn-gray, .name-type .Editable":function(i){var g=this;var h=$.getObj(i,"a");if(h.attr("id")){g.app.mainContainer.openCampaign(h.attr("id"))}},"click #camps_grid .btn-red":function(j){var h=this;var g=h.app.messages[0];var i=$.getObj(j,"a");if(i.attr("id")){h.app.showAlertDetail({heading:"Confirm Deletion",detail:g.CAMPS_delete_confirm_error,callback:_.bind(function(){h.$el.parents(".ws-content.active").find(".overlay").remove();h.deleteCampaign(i.attr("id"))},h)},h.$el.parents(".ws-content.active"))}},"click #camps_grid .btn-preview, #camps_grid a.notEditable":function(i){var g=this;var h=$.getObj(i,"a");if(h.attr("id")){g.previewCampaign(h.attr("id"),h.parents("tr").find(".name-type h3 a").html())}},"click #camps_grid .btn-copy":function(i){var g=this;var h=$.getObj(i,"a");if(h.attr("id")){g.copyCampaign(h.attr("id"))}},"click #camps_grid .btn-schedule,#camps_grid .btn-reschedule":function(i){var g=this;var h=$.getObj(i,"a");if(h.attr("id")){g.app.mainContainer.openCampaign(h.attr("id"))}},"click .stattype":function(k){var g=this;var j=this.app.messages[0];var m=$.getObj(k,"a");g.$el.find(".stattype").parent().removeClass("active");m.parent().addClass("active");var o=m.attr("search");var q="";if(this.$("#daterange").val()!=""){q=this.$("#daterange").val().split(" - ");if(q!=""&&q.length==1){q[1]=q[0]}}var h="";if(q){var r=q[0].split("/");var p=r[0]+"-"+r[1]+"-"+r[2].substring(2,4);var i=q[1].split("/");var l=i[0]+"-"+i[1]+"-"+i[2].substring(2,4);var h="fromDate="+p+"&toDate="+l}g.$el.find("#target-camps .bmsgrid").remove();g.app.showLoading("Loading Campaigns...",g.$("#target-camps"));var n="/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+g.app.get("bms_token")+"&type=listNormalCampaigns&offset=0&status="+o+"&"+h;jQuery.getJSON(n,function(v,s,u){g.app.showLoading(false,g.$("#target-camps"));if(u&&u.responseText){var t=jQuery.parseJSON(u.responseText);g.$el.find("#total_templates .badge").html(t.count);if(t.count>0){g.app.removeCache("campaigns");g.app.setAppData("campaigns",t);g.createListTable()}else{g.$el.find("#target-camps").html('<p class="notfound">'+j.CAMPS_name_empty_error+"</p>")}}else{g.$el.find("#target-camps").html('<p class="notfound">'+j.CAMPS_name_empty_error+"</p>")}})},"click .btn-draft":function(l){var j=this;var k=$.getObj(l,"a");var h=k.attr("id");var g="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+j.app.get("bms_token");j.app.showLoading("Changing Campaign to Draft...",j.$el.parents(".ws-content.active"));var i="";$.post(g,{type:"saveStep4",campNum:h,status:"D"}).done(function(n){j.app.showLoading(false,j.$el.parents(".ws-content.active"));i=jQuery.parseJSON(n);if(i[0]=="err"){j.app.showAlert(i[1],j.$el.parents(".ws-content.active"))}else{var m=j.app.messages[0];j.app.showMessge(m.CAMP_draft_success_msg);j.app.mainContainer.openCampaign(h)}})},"click .btnDone":function(j){var g=this;var l=$.getObj(j,"a");var h=l.html();switch(h){case"Yesterday":var o=this.$("#daterange").val().split(" - ");break;case"Today":var o=this.$("#daterange").val().split(" - ");break;case"Last 7 days":var o=this.$("#daterange").val().split(" - ");break;case"Last 30 Days":var o=this.$("#daterange").val().split(" - ");break;default:var o=this.$("#daterange").val().split(" - ");break}var p=o[0].split("/");var n=p[0]+"-"+p[1]+"-"+p[2].substring(2,4);var i=o[1].split("/");var k=i[0]+"-"+i[1]+"-"+i[2].substring(2,4);var m=g.$("ul#template_search_menu li.active a").attr("search");if(!m){m="A"}g.$el.find("#target-camps .bmsgrid").remove();g.app.removeCache("campaigns");g.app.showLoading("Loading Campaigns...",g.$("#target-camps"));g.app.getData({URL:"/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+g.app.get("bms_token")+"&type=listNormalCampaigns&offset=0&status="+m+"&fromDate="+n+"&toDate="+k,key:"campaigns",callback:_.bind(g.createListTable,g)})},"click .calendericon":function(g){this.$el.find("#daterange").click();return false},"click .cstats .closebtn":"closeChart"},previewCampaign:function(l,k){var g=this;var j=this.app.messages[0];var n=$(document.documentElement).width()-60;var h=$(document.documentElement).height()-182;var m=g.app.showDialog({title:"Campaign Preview of &quot;"+k+"&quot;",css:{width:n+"px","margin-left":"-"+(n/2)+"px",top:"10px"},headerEditable:false,headerIcon:"dlgpreview",bodyCss:{"min-height":h+"px"},buttons:{saveBtn:{text:"Email Preview",btnicon:"copycamp"}}});g.app.showLoading("Loading Campaign HTML...",m.getBody());var o="https://"+this.app.get("preview_domain")+"/pms/events/viewcamp.jsp?cnum="+l+"&html=Y&original=N";var i=$('<iframe class="email-iframe" style="height:'+h+'px" frameborder="0" src="'+o+'"></iframe>');m.getBody().html(i);m.saveCallBack(_.bind(this.sendTextPreview,this,l))},sendTextPreview:function(g){var k=this;var i=650;var l=100;var h=k.app.showDialog({title:"Email Preview",css:{width:i+"px","margin-left":"-"+(i/2)+"px",top:"20%"},headerEditable:false,headerIcon:"copycamp",bodyCss:{"min-height":l+"px"},buttons:{saveBtn:{text:"Send",btnicon:"copycamp"}}});var j='<div style=" min-height:100px;"  class="clearfix template-container gray-panel" id="create-template-container">';j+='<div class="cont-box" style="margin-top:10px; top:0; left:56%; width:90%;">';j+='<div class="row campname-container">';j+='<label style="width:10%;">To:</label>';j+='<div class="inputcont" style="text-align:right;">';j+='<input type="text" name="_email" id="send_email" placeholder="Enter comma separated email addresses" style="width:83%;" />';j+="</div></div></div></div>";j=$(j);h.getBody().html(j);j.find("#send_email").focus();j.find("#send_email").keydown(_.bind(function(m){if(m.keyCode==13){this.sendTestCampaign(h,g)}},this));h.saveCallBack(_.bind(this.sendTestCampaign,this,h,g))},sendTestCampaign:function(j,h){var l=this;var i=j.$el.find("#send_email").val();if(i){var k={toEmails:i};this.app.showLoading("Sending Email...",j.$el);var l=this;var g="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+this.app.get("bms_token")+"&campNum="+h+"&type=email";$.post(g,k).done(function(n){var m=jQuery.parseJSON(n);l.app.showLoading(false,j.$el);if(m[0]!=="err"){j.hide();l.app.showMessge("Email sent successfully!")}else{l.app.showAlert(m[1],$("body"),{fixed:true})}})}},deleteCampaign:function(h){var j=this;var i=this.app.messages[0];var g="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+j.app.get("bms_token");j.app.showLoading("Deleting Campaign...",j.$el.parents(".ws-content.active"));$.post(g,{type:"delete",campNum:h}).done(function(l){var k=jQuery.parseJSON(l);if(k[0]!=="err"){j.app.showMessge(i.CAMPS_delete_success_msg);j.$el.find("#area_copy_campaign .bmsgrid").remove();j.app.removeCache("campaigns");j.getallcampaigns()}else{j.app.showAlert(k[1],j.$el.parents(".ws-content.active"))}j.app.showLoading(false,j.$el.parents(".ws-content.active"))})},createCampaign:function(){var h=this;var i="New Campaign";var g=this.app.showDialog({title:i,css:{width:"650px","margin-left":"-325px"},bodyCss:{"min-height":"100px"},headerIcon:"new_headicon",buttons:{saveBtn:{text:"Create Campaign"}}});this.app.showLoading("Loading...",g.getBody());require(["newcampaign"],function(j){var k=new j({camp:h,app:h.app,newcampdialog:g});g.getBody().html(k.$el);g.saveCallBack(_.bind(k.createCampaign,k))})},copyCampaign:function(g){var i=this;var j="Copy Campaign";var h=this.app.showDialog({title:j,css:{width:"600px","margin-left":"-300px"},bodyCss:{"min-height":"260px"},headerIcon:"copycamp",buttons:{saveBtn:{text:"Create Campaign"}}});this.app.showLoading("Loading...",h.getBody());require(["copycampaign"],function(k){var l=new k({camp:i,camp_id:g,app:i.app,copycampsdialog:h});h.getBody().html(l.$el);h.saveCallBack(_.bind(l.copyCampaign,l))})},findCampaigns:function(j){var g=this;var i=this.app.messages[0];var m=$.getObj(j,"a");if(m.html()!="Date Range"){if(m.prevObject&&m.prevObject[0].localName=="span"){m=$.getObj(j,"span");g.$el.find(".stattype").parent().removeClass("active");switch(m.attr("search")){case"C":g.$el.find(".sent").parent().addClass("active");break;case"P":g.$el.find(".pending").parent().addClass("active");break;case"S":g.$el.find(".scheduled").parent().addClass("active");break;case"D":g.$el.find(".draft").parent().addClass("active");break}}var l=m.attr("dateStart");var s=m.attr("dateEnd");var q=[];if(l){q[0]=$.datepicker.formatDate("m/d/yy",Date.parse(l));q[1]=$.datepicker.formatDate("m/d/yy",Date.parse(s))}else{q=this.$("#daterange").val().split(" - ");if(q!=""&&q.length==1){q[1]=q[0]}}if(q!=""){var r=q[0].split("/");var p=r[0]+"-"+r[1]+"-"+r[2].substring(2,4);var h=q[1].split("/");var k=h[0]+"-"+h[1]+"-"+h[2].substring(2,4)}var o=m.attr("search");if(!o){o=$("#template_search_menu li.active a").attr("search")}if(m.attr("class")=="stattype topbadges"){g.$el.find("#template_search_menu li").removeClass("active");$("#template_search_menu").find("li").each(function(t){if($(this).find("a").attr("search")==o){$(this).addClass("active")}})}g.$el.find("#target-camps .bmsgrid").remove();g.app.showLoading("Loading Campaigns...",g.$("#target-camps"));if(q!=""){var n="/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+g.app.get("bms_token")+"&type=listNormalCampaigns&offset=0&status="+o+"&fromDate="+p+"&toDate="+k}else{var n="/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+g.app.get("bms_token")+"&type=listNormalCampaigns&offset=0&status="+o}jQuery.getJSON(n,function(w,t,v){g.app.showLoading(false,g.$("#target-camps"));if(v&&v.responseText){var u=jQuery.parseJSON(v.responseText);g.$el.find("#total_templates .badge").html(u.count);if(u.count>0){g.app.removeCache("campaigns");g.app.setAppData("campaigns",u);g.createListTable()}else{g.$el.find("#target-camps").html('<p class="notfound">'+i.CAMPS_name_empty_error+"</p>")}}else{g.$el.find("#target-camps").html('<p class="notfound">'+i.CAMPS_name_empty_error+"</p>")}})}},initialize:function(){this.template=_.template(b);this.render()},render:function(){this.$el.html(this.template({}));this.app=this.options.app;var g=this;g.getallcampaigns();g.$el.find("div#campslistsearch").searchcontrol({id:"list-search",width:"300px",height:"22px",placeholder:"Search Campaigns",gridcontainer:"camps_grid",showicon:"yes",iconsource:"campaigns",countcontainer:"no_of_camps"});g.$(".showtooltip").tooltip({placement:"bottom",delay:{show:0,hide:0},animation:false})},init:function(){this.$el.find("#daterange").daterangepicker();$(".btnDone").click(_.bind(this.findCampaigns,this));$(".ui-daterangepicker li a").click(_.bind(function(k){this.$el.find("#clearcal").show();this.findCampaigns(k)},this));$("#daterange").keyup(_.bind(function(k){this.$el.find("#clearcal").show();this.findCampaigns(k)},this));var i=this;var h=this.$el.parents(".ws-content");var j=h.find(".camp_header .edited  h2");h.find("#addnew_action").attr("data-original-title","Add new Campaign").click(_.bind(this.createCampaign,this));var g="/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+i.app.get("bms_token");$.post(g,{type:"allStats"}).done(function(m){var l=jQuery.parseJSON(m);if(i.app.checkError(l)){return false}var n=h.find(".camp_header .edited");var k='<ul class="c-current-status">';k+='<li><span class="badge pclr18 stattype topbadges" tabindex="-1" search="C">'+l.sent+"</span>Sent</li>";k+='<li><span class="badge pclr6 stattype topbadges" tabindex="-1" search="P">'+l.pending+"</span>Pending</li>";k+='<li><span class="badge pclr2 stattype topbadges" tabindex="-1" search="S">'+l.scheduled+"</span>Scheduled</li>";k+='<li><span class="badge pclr1 stattype topbadges" tabindex="-1" search="D">'+l.draft+"</span>Draft</li>";k+="</ul>";n.append(k);$(".c-current-status li span").click(_.bind(i.findCampaigns,i))});this.current_ws=this.$el.parents(".ws-content");this.tagDiv=this.current_ws.find("#campaign_tags");this.tagDiv.hide()},getallcampaigns:function(){this.$el.find("#target-camps .bmsgrid").remove();if(!this.app.getAppData("campaigns")){this.app.showLoading("Loading Campaigns...",this.$("#target-camps"));this.app.getData({URL:"/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=listNormalCampaigns&offset=0",key:"campaigns",callback:_.bind(this.createListTable,this)})}else{this.app.showLoading("Loading Campaigns...",this.$("#target-camps"));window.setTimeout(_.bind(this.createListTable,this),500)}},createListTable:function(){var j=this;var g=this.app.getAppData("campaigns");var i='<table cellpadding="0" cellspacing="0" width="100%" id="camps_grid"><tbody>';if(g.count!=="0"){$.each(g.campaigns[0],function(k,l){i+=j.makecamprows(l)});i+="</tbody></table>";this.app.showLoading(false,j.$el.find("#target-camps"));this.$el.find("#target-camps").html(i);this.$("#camps_grid").bmsgrid({useRp:false,resizable:false,colresize:false,lazyLoading:_.bind(this.appendCampaigns,this),height:"100%",usepager:false,colWidth:["100%","70px","140px"]});this.$("#camps_grid tr td:nth-child(1)").attr("width","100%");this.$("#camps_grid tr td:nth-child(2)").attr("width","90px");this.$("#camps_grid tr td:nth-child(3)").attr("width","140px");this.$("#camps_grid tr .showtooltip").tooltip({placement:"bottom",delay:{show:0,hide:0},animation:false});this.$("#camps_grid tr td:nth-child(1) .report").click(_.bind(this.showChart,this))}else{this.$("#area_copy_campaign .bmsgrid").remove()}var h="";if(parseInt(g.count)==parseInt(g.totalCount)){this.$("#camps_grid tr:last-child").removeAttr("data-load")}this.$el.find("#total_templates .badge").html(g.totalCount);this.app.showLoading(false,this.$("#target-camps"));this.$el.find(".taglink").click(_.bind(function(k){j.app.initSearch(k,this.$el.find("#list-search"))},this))},makecamprows:function(x,g){var s=this;var q="",l="";if(g){q="<div>";l="</div>"}var m="";if(x[0].status=="D"){m="pclr1"}else{if(x[0].status=="P"){m="pclr6"}else{if(x[0].status=="S"){m="pclr2"}else{if(x[0].status=="C"){m="pclr18"}}}}var w='<tr id="row_'+x[0]["campNum.encode"]+'">';var v="";var j="notEditable";if(x[0].status=="P"||x[0].status=="C"){v='<div class="campaign_stats showtooltip" title="Click to View Chart"><a class="icon report"></a></div>'}if(x[0].status=="D"||x[0].status=="S"){j="Editable"}else{if(x[0].status=="C"||x[0].status=="P"){j="notEditable"}}w+='<td class="firstcol">'+q+'<div class="name-type"><h3><a id="'+x[0]["campNum.encode"]+'" class="campname '+j+'">'+x[0].name+'</a><a class="cstatus '+m+'">'+this.app.getCampStatus(x[0].status)+"</a>"+v+'</h3>   <div class="tags tagscont">'+this.app.showTags(x[0].tags)+"</div></div>"+l+"</td>";var h="";var k="";if(x[0].status!="D"){k="<em>Schedule Date</em>";h=x[0].scheduledDate}else{k="<em>Updation Date</em>";if(x[0].updationDate){h=x[0].updationDate}else{h=x[0].creationDate}}if(h){var t=h.split(" ");var n=t[0].split("-");var u=s.app.getMMM(n[1].replace("0","")-1);var o=n[2]+" "+u+", "+n[0]}else{o=""}if(x[0].status!="D"){w+="<td>"+q+'<div class="subscribers show" style="min-width:60px"><strong><span><em>Sent</em>'+x[0].sentCount+"</span></strong></div>"+l+"</td>"}else{w+="<td>"+q+""+l+"</td>"}var i="";var r="";switch(x[0].status){case"D":r="DL,P,C,S,E";break;case"S":r+="DL,P,C,R,DR";break;case"C":r+="DL,P,C";break;case"P":r+="P,C";break}i=s.drawButtons(r,x[0]["campNum.encode"]);var p="";if(o!=""){p='<div class="time show" style="width:105px"><strong><span>'+k+o+"</span></strong></div>"}w+="<td>"+q+p+'<div id="'+x[0]["campNum.encode"]+'" class="action">'+i+"</div>"+l+"</td>";w+="</tr>";return w},drawButtons:function(l,g){var j=[];j.DL='<a id="'+g+'" class="btn-red"><i class="icon delete"></i></a>';j.P='<a id="'+g+'" class="btn-blue btn-preview"><span>Preview</span><i class="icon preview3"></i></a>';j.C='<a id="'+g+'" class="btn-green btn-copy"><span>Copy</span><i class="icon copy"></i></a>';j.S='<a id="'+g+'" class="btn-green btn-schedule"><span>Schedule</span><i class="icon time2"></i></a>';j.E='<a id="'+g+'" class="btn-gray btn-edit"><span>Edit</span><i class="icon edit"></i></a>';j.R='<a id="'+g+'" class="btn-green btn-reschedule"><span>Reschedule</span><i class="icon time2"></i></a>';j.DR='<a id="'+g+'" class="btn-blue btn-draft"><span>Draft</span><i class="icon time2"></i></a>';var l=l.split(",");var k="";for(var h=0;h<l.length;h++){k+=j[l[h]]}return k},appendCampaigns:function(){var h=this.app.getAppData("campaigns");if(h){var k=this;var j=h.offset?(h.offset+50):50;var i="";var g="/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=listNormalCampaigns&offset="+j;jQuery.getJSON(g,function(p,m,o){if(o&&o.responseText){var n=jQuery.parseJSON(o.responseText);if(k.app.checkError(n)){return false}var l=1;k.$("#target-camps .footer-loading").remove();h.offset=j;$.each(n.campaigns[0],function(q,r){i=$(k.makecamprows(r,true));if(l==50&&h.offset+parseInt(n.count)<parseInt(n.totalCount)){i.attr("data-load","true")}h.campaigns[0]["campaign"+(j+l)]=r;k.$("#camps_grid tbody").append(i);l=l+1});h.count=parseInt(h.count)+parseInt(n.count);k.$el.find(".taglink").click(_.bind(function(q){k.app.initSearch(q,k.$el.find("#list-search"))},k))}}).fail(function(){console.log("error in campaign lazy loading fields")})}else{this.getallcampaigns()}},showChart:function(j){var g=$.getObj(j,"div");var i=96;var o=g.offset();var k=g.height();var n=o.top+k-134;var h=o.left-i;var l=this;var m=g.parents("tr").attr("id").split("_")[1];this.$(".campaign-name").html(g.parents("tr").find("h3 a.campname").text());this.app.showLoading("Loading Chart...",this.$(".cstats .chart-area"));if(!this.chartPage){require(["reports/campaign_pie_chart"],function(p){l.chartPage=new p({page:l,legend:"none",chartArea:{width:"95%",height:"95%",left:"0px",top:"0px"}});l.$(".campaign-chart").html(l.chartPage.$el);l.chartPage.$el.css({width:"280px",height:"280px"});l.loadChart(m)})}else{this.loadChart(m)}this.$(".cstats").css({left:h+"px",top:n+"px"}).show()},closeChart:function(){this.$(".cstats").hide()},loadChart:function(h){var g="/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=stats";g+="&campNums="+h;if(this.states_call){this.states_call.abort();this.states_call=null}this.chart_data={clickCount:0,conversionCount:0,openCount:0,pageViewsCount:0,sentCount:0};this.states_call=jQuery.getJSON(g,_.bind(function(m,k,l){var j=jQuery.parseJSON(l.responseText);this.app.showLoading(false,this.$(".cstats .chart-area"));_.each(j.campaigns[0],function(n){this.chart_data.clickCount=this.chart_data.clickCount+parseInt(n[0].clickCount);this.chart_data.conversionCount=this.chart_data.conversionCount+parseInt(n[0].conversionCount);this.chart_data.openCount=this.chart_data.openCount+parseInt(n[0].openCount);this.chart_data.pageViewsCount=this.chart_data.pageViewsCount+parseInt(n[0].openCount)},this);var i=[["Action","Count"],["Opens",this.chart_data.openCount],["Page Views",this.chart_data.pageViewsCount],["Conversions",this.chart_data.conversionCount],["Clicks",this.chart_data.clickCount]];this.chartPage.createChart(i);_.each(this.chart_data,function(o,n){this.$("."+n).html(this.app.addCommas(o))},this)},this))}})});