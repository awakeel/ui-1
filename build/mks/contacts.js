define(["jquery.searchcontrol","contacts/collections/subscribers","text!html/contacts.html","jquery.chosen","jquery.icheck","contacts/subscriber_row"],function(e,d,c,a,f,b){return Backbone.View.extend({id:"contacts_list",events:{"click .show-detail":function(h){var g=$.getObj(h,"div");if(g.attr("id")){this.app.mainContainer.openSubscriber(g.attr("id"))}}},initialize:function(){_.bindAll(this,"searchByTag","updateRefreshCount");this.template=_.template(c);this.subscriberRequest=new d();this.offset=0;this.searchTxt="";this.tagTxt="";this.contacts_request=null;this.sortBy="lastActivityDate";this.render()},render:function(){this.$el.html(this.template({}));this.app=this.options.app;this.$contactList=this.$(".contactsdiv");this.$contactLoading=this.$(".loadmore");this.initControls();this.fetchContacts()},init:function(){this.current_ws=this.$el.parents(".ws-content");this.current_ws.find("#campaign_tags").hide();this.ws_header=this.current_ws.find(".camp_header .edited");this.addCountHeader();this.fetchCount()},addCountHeader:function(){var h='<ul class="c-current-status">';h+='<li><span class="badge pclr18 tcount">0</span>Total Contacts</li>';h+='<li><span class="badge pclr11 suppressCount">0</span>Suppressed</li>';h+='<li style="display:none"><span class="badge pclr15 hiddenCount" >0</span>Hidden</li>';h+='<li><span class="badge pclr23 addCount">0</span>Added in Last 24hrs </li>';h+="</ul>";var g=$(h);this.ws_header.append(g)},initControls:function(){this.$("input.checkpanel").iCheck({checkboxClass:"checkpanelinput",insert:'<div class="icheck_line-icon"></div>'});this.$("input.checkpanel").on("ifChecked",_.bind(function(g){this.$(".contact-row-check").iCheck("check")},this));this.$("input.checkpanel").on("ifUnchecked",_.bind(function(g){this.$(".contact-row-check").iCheck("uncheck")},this));this.$(".recent-activities").chosen({width:"220px",disable_search:"true"});this.$(".recent-activities").change(_.bind(this.sortContacts,this));this.$(".contact-search").searchcontrol({id:"contact-search",width:"180px",height:"22px",searchFunc:_.bind(this.searchContacts,this),clearFunc:_.bind(this.clearSearchContacts,this),placeholder:"Search Contacts & Tags",showicon:"yes",iconsource:"subscribers"});$(window).scroll(_.bind(this.liveLoading,this));$(window).resize(_.bind(this.liveLoading,this))},fetchCount:function(){var h=this.app.get("bms_token");var i=this;var g="/pms/io/subscriber/getData/?BMS_REQ_TK="+h+"&type=getSAMSubscriberStats";jQuery.getJSON(g,_.bind(function(m,k,l){i.app.showLoading(false,i.$el);var j=jQuery.parseJSON(l.responseText);if(i.app.checkError(j)){return false}_.each(j,function(o,n){i.ws_header.find("."+n).html(i.app.addCommas(o))})}),this)},fetchContacts:function(i){var g=false;if(!i){g=true;this.offset=0;this.$contactList.children(".contactbox").remove();this.app.showLoading("Loading Contacts...",this.$contactList);this.$(".notfound").remove()}else{this.offset=this.offset+20}var h={offset:this.offset};if(this.searchTxt){h.searchValue=this.searchTxt}else{if(this.tagTxt){h.searchTag=this.tagTxt}}delete h.order;if(this.sortBy){if(this.sortBy=="firstName"){h.order="asc";h.orderBy=this.sortBy}h.orderBy=this.sortBy}if(this.contacts_request){this.contacts_request.abort()}this.$(".refreshbtn").show();this.$("#total_templates").hide();this.contacts_request=this.subscriberRequest.fetch({data:h,remove:g,success:_.bind(function(m,j){if(this.app.checkError(j)){return false}this.app.showLoading(false,this.$contactList);this.showTotalCount(j.totalCount);this.$contactLoading.hide();for(var k=this.offset;k<m.length;k++){var n=new b({model:m.at(k),sub:this});n.on("tagclick",this.searchByTag);n.on("updatecount",this.updateRefreshCount);this.$contactLoading.before(n.$el)}if(m.length<parseInt(j.totalCount)){this.$(".contactbox").last().attr("data-load","true")}if(m.length==0){var l="";if(this.searchTxt){l+=" containing '"+this.searchTxt+"'"}this.$contactLoading.before('<p class="notfound">No Contacts found'+l+"</p>")}},this),error:function(k,j){}})},liveLoading:function(){var h=$(window);var g=200;var i=this.$(".contactbox").last().filter(function(){var k=$(this),j=h.scrollTop(),m=j+h.height(),n=k.offset().top,l=n+k.height();return l>=j-g&&n<=m+g});if(i.length&&i.attr("data-load")&&this.$el.height()>0){i.removeAttr("data-load");this.$contactLoading.show();this.fetchContacts(20)}},searchContacts:function(i,g){this.tagTxt="";this.searchTxt=g;if(i.keyCode==13&&this.searchTxt){if(this.searchTxt.indexOf("Tag: ")>-1){var h=this.searchTxt.split(": ");this.searchByTag(h[1])}else{this.fetchContacts()}}},clearSearchContacts:function(){this.tagTxt="";this.searchTxt="";this.fetchContacts()},sortContacts:function(){this.sortBy=this.$(".recent-activities").val();this.fetchContacts()},showTotalCount:function(g){this.$(".refreshbtn").hide();this.$("#total_templates").show();this.$(".total-count").html(this.app.addCommas(g));if(this.ws_header.find(".tcount").html()=="0"){this.ws_header.find(".tcount").html(this.app.addCommas(g))}var h=g=="1"?"Contact":"Contacts";if(this.tagTxt){this.$(".total-text").html(h+" found containing tag '<b>"+this.tagTxt+"</b>'")}else{if(this.searchTxt){this.$(".total-text").html(h+" found containing text or tag '<b>"+this.searchTxt+"</b>'")}else{this.$(".total-text").html(h)}}this.$("#total_selected").hide()},searchByTag:function(g){this.searchTxt="";this.$("#contact-search").val("Tag: "+g);this.$("#clearsearch").show();this.tagTxt=g;this.fetchContacts()},updateRefreshCount:function(){var g=this.$(".contact-row-check:checked").length;if(g>0){this.$("#total_templates").hide();this.$("#total_selected").show();this.$(".total-selected-count").html(g);var h=g>1?"contacts":"contact";this.$(".total-selected-text").html(h+" selected")}else{this.$("#total_templates").show();this.$("#total_selected").hide()}}})});