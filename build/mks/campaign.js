define(["jquery.bmsgrid","jquery.calendario","jquery.chosen","jquery.icheck","jquery.searchcontrol","jquery.highlight","jquery-ui","text!html/campaign.html","editor","bms-tags","bms-filters","bms-mapping","moment"],function(j,c,f,e,d,l,i,k,b,h,a,g,m){return Backbone.View.extend({id:"step_container",events:{"click .step3 #choose_soruce li":function(o){var n=o.target.tagName=="LI"?$(o.target):$(o.target).parents("li");if(n.hasClass("selected")){return false}this.$(".step3 #choose_soruce li").removeClass("selected");this.$(".step3 .soruces").hide();this.$(".step3 #area_"+n.attr("id")).fadeIn("fast");n.addClass("selected");this.step3SlectSource(n)},"click .step2 #choose_soruce li":function(p){var o=this;var n=$.getObj(p,"li");if(this.$(".step2 #choose_soruce li.selected").length==0){this.$(".step2 .selection-boxes").animate({width:"560px",margin:"0px auto"},"medium",function(){$(this).removeClass("create-temp");o.step2SlectSource(n)})}else{this.step2SlectSource(n)}},"click #campMenubtn":function(){var n=$("#campMenu").val();this.loadCampaign(n)},"keyup .header-info":function(o){var n=$(o.target);if(n.val().indexOf("{{")==-1&&n.val().indexOf("}}")==-1){$("#"+n.attr("id")+"_default").hide()}},"click #save_conversion_filter":function(){this.saveConversionPage()},"click #save_results_sf":function(){this.saveResultToSF()},"click .mergefields-box":function(n){this.showMergeFieldDialog(n)},"click #drop4":function(n){this.$el.find(".mergefields-box").click()},"change #campaign_isFooterText":function(){this.setFooterArea()},"change .step1 input":function(){this.states.step1.change=true},"change .step1 select":function(){this.states.step1.change=true},"change .step1 textarea":function(){this.states.step1.change=true},"change .step2 #myhtml":function(){this.states.editor_change=true},"click .step3 #addnew_target":function(){this.createTarget()},"change .step3 select":function(){this.states.step3.change=true},"keydown .step3 input":function(){this.states.step3.change=true},"click .step3 a":function(){this.states.step3.change=true},"click #btnSFLogin":function(){var o=this;var n=this.app.showDialog({title:"Salesforce Login Setup",css:{width:"650px","margin-left":"-325px"},bodyCss:{"min-height":"360px"}});this.app.showLoading("Loading Login...",n.getBody());require(["crm/salesforce/login"],function(p){var q=new p({camp:self,app:o.app,dialog:n});n.getBody().html(q.$el)});this.$("#salesforce_welcome").hide();this.$("#salesforce_mapping").hide();this.$("#salesforce_login").show();this.$("#salesforce_setup").hide();return false},"click #btnNSLogin":function(){var o=this;var n=this.app.showDialog({title:"NetSuite Login Setup",css:{width:"650px","margin-left":"-325px"},bodyCss:{"min-height":"360px"}});this.app.showLoading("Loading Login...",n.getBody());require(["crm/netsuite/login"],function(p){var q=new p({camp:o,app:o.app,dialog:n});n.getBody().html(q.$el)});this.$("#netsuite_welcome").hide();this.$("#netsuite_mapping").hide();this.$("#netsuite_login").show();this.$("#netsuite_setup").hide();return false},"click .scheduled-campaign":function(){var n=this;this.scheduledCampaign("S","Scheduling Campaign...")},"click .draft-campaign":function(o){var n=$.getObj(o,"a");if(n.hasClass("reschedule")){this.$(".schedule-camp").show();this.$(".sch-made").hide();this.setScheduleArea()}else{if(n.hasClass("edit")){this.scheduledCampaign("D","Edit Campaign...")}else{this.scheduledCampaign("D","Changing Campaign to Draft...")}}}},initialize:function(){this.template=_.template(k);this.tags="";this.tag_limit=5;this.camp_id=0;this.tags_common=[];this.mergeTags={};this.allMergeTags=[];this.wp_id=this.options.params.wp_id;this.states={step1:{change:false,sf_checkbox:false,sfCampaignID:"",hasResultToSalesCampaign:false,pageconversation_checkbox:false,hasConversionFilter:false},step2:{templates:false,htmlText:"",change:false},step3:{target_id:0,salesforce:false,netsuite:false,recipientType:"",recipientDetial:null,change:false,netsuitegroups:null,targetDialog:null,csvupload:null,mapdataview:null,tags:null,sf_filters:{lead:"",contact:""},ns_filters:{customer:"",contact:"",parnter:"",nsObject:"",isNewTarget:false,newTargetName:""}},step4:{init:false,datetime:{day:0,month:0,year:0,hour:0,min:0,sec:0},cal:null,camp_status:"D",sch_date:""},editor_change:false,saleforce_campaigns:null};this.bmseditor=new b({opener:this,wp_id:this.wp_id});this.render();var n=this.app.messages[0];this.app.showInfo(this.$el.find("#lblSubject"),n.CAMP_subject_info);this.app.showInfo(this.$el.find("#lblFromemail"),n.CAMP_femail_info);this.app.showInfo(this.$el.find("#lblFromname"),n.CAMP_fname_info);this.app.showInfo(this.$el.find("#lblReplyto"),n.CAMP_replyto_info)},render:function(){this.$el.html(this.template({}));this.app=this.options.app;this.wizard=this.options.wizard;if(this.options.params&&this.options.params.camp_id){this.camp_id=this.options.params.camp_id}this.loadDataAjax();this.$el.find("div#copycampsearch").searchcontrol({id:"copy-camp-search",width:"300px",height:"22px",placeholder:"Search Campaigns",gridcontainer:"camp_list_grid",showicon:"yes",iconsource:"campaigns",countcontainer:"copy_no_of_camps"});this.$el.find("div#listssearch").searchcontrol({id:"list-search",width:"300px",height:"22px",placeholder:"Search Lists",gridcontainer:"list_grid",showicon:"yes",iconsource:"list"});this.$el.find("div#listrecpssearch").searchcontrol({id:"list-recps-search",width:"300px",height:"22px",placeholder:"Search Recipients",gridcontainer:"recipients",showicon:"yes",iconsource:"list"});this.$el.find("div#targetssearch").searchcontrol({id:"target-list-search",width:"300px",height:"22px",placeholder:"Search Lists",gridcontainer:"target_list_grid",showicon:"no",iconsource:""});this.$el.find("div#targetrecpssearch").searchcontrol({id:"target-recps-search",width:"300px",height:"22px",placeholder:"Search Recipients",gridcontainer:"recipients",showicon:"yes",iconsource:"target"});this.$el.find("div#targetsearch").searchcontrol({id:"target-search",width:"300px",height:"22px",placeholder:"Search Targets",gridcontainer:"targets_grid",showicon:"yes",iconsource:"target"});this.$(".showtooltip").tooltip({placement:"bottom",delay:{show:0,hide:0},animation:false})},stepsCall:function(o){var n=-1;if(this.states.step4.camp_status==="D"){if(this.camp_id!==0){switch(o){case"step_1":n=this.saveStep1();break;case"step_2":n=this.saveStep2();break;case"step_3":n=this.saveStep3();break;case"step_4":n=this.saveStep4();break;default:break}}else{this.app.showAlert("Please save campaign first to proceed!",this.$el.parents(".ws-content.active"));n=0}}return n},removeCSVUpload:function(){var o=this;var n=o.states.step3.csvupload;if(n&&n.fileuploaded==true){n.removeFile();n.$el.hide();o.$el.find("#upload_csv").removeClass("selected");o.states.step3.mapdataview.$el.hide();o.states.step3.mapdataview.$el.find("#uploadslist").children().remove();o.states.step3.mapdataview.$el.find("#newlist").val("");o.states.step3.mapdataview.$el.find("#alertemail").val("");o.app.showLoading(false,o.states.step3.mapdataview.$el)}},init:function(){this.mergeFieldsSetup();this.initHeader();this.setupCampaign();if(this.camp_id!="0"){this.loadCampaign(this.camp_id)}else{this.initCampaignTag("");this.initCheckbox()}this.$("#campaign_add_to_salesforce_accordion").accordion({active:0,collapsible:false,activate:_.bind(function(){this.$("#campaign_add_to_salesforce").prop("checked",this.states.step1.sf_checkbox)},this)});this.$("#conversion_filter_accordion").accordion({active:0,collapsible:false,activate:_.bind(function(){this.$("#conversion_filter").prop("checked",this.states.step1.pageconversation_checkbox)},this)});this.$el.parents(".ws-content").append(this.bmseditor.$el);this.bmseditor.initEditor({id:this.wp_id});this.$("#con_filter_combo").chosen({no_results_text:"Oops, nothing found!",width:"280px",disable_search:"true"});this.$("#campaign_unSubscribeType").chosen({no_results_text:"Oops, nothing found!",width:"290px",disable_search:"true"});this.$("#campaign_unSubscribeType").chosen().change(_.bind(function(){this.states.step1.change=true;$(this).trigger("chosen:updated")},this));this.$("#campaign_from_email").chosen({no_results_text:"Oops, nothing found!",disable_search:"true"});var n=this;this.$("#campaign_from_email").chosen().change(function(){n.fromNameSelectBoxChange(this)});this.$("#fromemail_default").chosen({no_results_text:"Oops, nothing found!",width:"67%",disable_search:"true"});this.$("#sf_campaigns_combo").chosen({no_results_text:"Oops, nothing found!",width:"280px",disable_search:"true"})},fromNameSelectBoxChange:function(n){var o=new RegExp("{{[A-Z0-9_-]+(?:(\\.|\\s)*[A-Z0-9_-])*}}","ig");if(o.test($(n).val())){this.$("#campaign_from_email_default").show()}else{this.$("#campaign_from_email_default").hide()}},initCheckbox:function(){this.$("input").iCheck({checkboxClass:"checkinput"});this.$("input.checkpanel").iCheck({checkboxClass:"checkpanelinput",insert:'<div class="icheck_line-icon"></div>'});this.$("ul.socialbtns li label ").click(function(){$(this).toggleClass("btnchecked")});var n=this;this.$(".iCheck-helper").click(function(){var p=$(this).parent().find("input");if(p.attr("type")=="checkbox"){var o=p.attr("id");if(o=="campaign_isFooterText"){n.setFooterArea()}else{if(o=="campaign_add_to_salesforce"){n.setSalesForceStep1(p)}else{if(o=="conversion_filter"){n.setCoversionPageStep1(p)}else{if(o=="campaign_fb"||o=="campaign_twitter"||o=="campaign_linkedin"||o=="campaign_pintrest"||o=="campaign_gplus"){if($(this).parent().next().hasClass("btnchecked")){$(this).parent().next().removeClass("btnchecked")}else{$(this).parent().next().addClass("btnchecked")}}}}}}if(n.wizard.active_step==1){n.states.step1.change=true}})},initTemplateListing:function(){this.$el.find("#camp_list_grid").bmsgrid({useRp:false,resizable:false,colresize:false,height:this.app.get("wp_height")-122,usepager:false,colWidth:["100%","90px","66px","132px"]});this.$("#camp_list_grid tr td:nth-child(1)").attr("width","100%");this.$("#camp_list_grid tr td:nth-child(2)").attr("width","90px");this.$("#camp_list_grid tr td:nth-child(4)").attr("width","132px")},loadCampaign:function(o){if(o==="0"||o===0){return false}var p=this.app.get("bms_token");var n="/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+p+"&campNum="+o+"&type=basic";var q=this;q.$(".step1 input").val("");q.$(".step1 input[type='checkbox']").prop("checked",false);this.camp_id=o;this.setupCampaign();this.app.showLoading(true,this.$el.parents(".ws-content"));$("#campMenubtn").attr("disabled",true).html("Loading...");jQuery.getJSON(n,function(y,v,x){var u=jQuery.parseJSON(x.responseText);$("#campMenubtn").attr("disabled",false).html("Load");if(q.app.checkError(u)){return false}q.$el.parents(".ws-content").find("#workspace-header").html(u.name);q.$("#campaign_subject").val(q.app.decodeHTML(u.subject));var w=new RegExp("{{[A-Z0-9_-]+(?:(\\.|\\s)*[A-Z0-9_-])*}}","ig");if(u.fromEmail!=""){if(w.test(q.app.decodeHTML(u.fromEmail))){var r=q.app.decodeHTML(u.fromEmail);q.$("#campaign_from_email").prepend("<option value='"+r+"'>"+r+"</option");q.$("#campaign_from_email").val(r).trigger("chosen:updated");q.$("#campaign_from_email_default").show();q.$("#fromemail_default").val(q.app.decodeHTML(u.defaultFromEmail)).trigger("chosen:updated")}else{q.$("#campaign_from_email").val(q.app.decodeHTML(u.fromEmail)).trigger("chosen:updated");q.$("#campaign_from_email_default").hide()}}var t=q.$el.find("#campaign_subject").width();var s=q.$el.find("#fecol3").width();q.$("#campaign_from_email_chosen").width(parseInt(t-s)+25);if(u.senderName!=""){q.$("#campaign_from_name").val(q.app.decodeHTML(u.senderName))}else{q.states.step1.change=true}q.$("#campaign_reply_to").val(q.app.decodeHTML(u.replyTo));q.$("#campaign_footer_text").val(u.footerText);q.states.step2.htmlText=u.htmlText;q.states.step3.recipientType=u.recipientType;if(u.defaultSenderName!=""){if(u.defaultSenderName){q.$("#campaign_from_name_default").show();q.$("#campaign_default_from_name").val(u.defaultSenderName)}else{q.$("#campaign_from_name_default").hide()}}if(u.defaultReplyTo){q.$("#campaign_reply_to_default").show();q.$("#campaign_default_reply_to").val(u.defaultReplyTo)}else{q.$("#campaign_reply_to_default").hide()}q.$("#campaign_socail_networks").prop("checked",u.isShareIcons=="N"?false:true);q.$("#campaign_fb").prop("checked",u.facebook=="N"?false:true);if(u.facebook=="Y"){q.$("label[for='campaign_fb']").addClass("btnchecked")}q.$("#campaign_twitter").prop("checked",u.twitter=="N"?false:true);if(u.twitter=="Y"){q.$("label[for='campaign_twitter']").addClass("btnchecked")}q.$("#campaign_linkedin").prop("checked",u.linkedin=="N"?false:true);if(u.linkedin=="Y"){q.$("label[for='campaign_linkedin']").addClass("btnchecked")}q.$("#campaign_pintrest").prop("checked",u.pinterest=="N"?false:true);if(u.pinterest=="Y"){q.$("label[for='campaign_pintrest']").addClass("btnchecked")}q.$("#campaign_gplus").prop("checked",u.googleplus=="N"?false:true);if(u.googleplus=="Y"){q.$("label[for='campaign_gplus']").addClass("btnchecked")}q.$("select#campaign_unSubscribeType").val(u.unSubscribeType).trigger("chosen:updated");q.$("#campaign_profileUpdate").prop("checked",u.profileUpdate=="N"?false:true);q.$("#campaign_useCustomFooter").prop("checked",u.useCustomFooter=="N"?false:true);q.$("#campaign_isFooterText").prop("checked",u.isFooterText=="N"?false:true);q.$("#campaign_tellAFriend").prop("checked",u.tellAFriend=="N"?false:true);q.$("#campaign_isTextOnly").prop("checked",u.isTextOnly=="N"?false:true);q.$("#campaign_isWebVersion").prop("checked",u.isWebVersionLink=="N"?false:true);q.setFooterArea();q.tags=q.app.encodeHTML(u.tags);q.initCampaignTag(q.tags);if(u.addToSFStatus=="Y"){q.states.step1.hasResultToSalesCampaign=true;q.$("#campaign_add_to_salesforce").prop("checked",true);q.states.step1.sf_checkbox=true;q.states.step1.sfCampaignID=u.sfCampaignID;if(q.states.saleforce_campaigns===null){q.showSalesForceCampaigns()}else{q.$("#sf_campaigns_combo").prop("disabled",false).val(u.sfCampaignID).trigger("chosen:updated")}q.$("#accordion").accordion({active:0})}else{q.states.step1.hasResultToSalesCampaign=false;q.$("#campaign_add_to_salesforce").prop("checked",false);q.states.step1.sf_checkbox=false;q.$("#accordion").accordion({active:false})}if(u.conversionFilterStatus=="Y"){q.$("#conversion_filter").prop("checked",true);q.states.step1.hasConversionFilter=true;q.states.step1.pageconversation_checkbox=true;n="/pms/io/filters/getLinkIDFilter/?BMS_REQ_TK="+p+"&type=get&campNum="+o;jQuery.getJSON(n,function(D,B,C){var z=jQuery.parseJSON(C.responseText);if(q.app.checkError(z)){return false}q.setConversionPage();if(z.ruleCount>0){var A=z.rules[0].rule1[0];q.$("select#con_filter_combo").val(q.app.decodeHTML(A.rule));q.$("#con_filter_field").val(q.app.decodeHTML(A.matchValue));q.setConversionPage()}});q.$("#accordion1").accordion({active:0})}else{q.states.step1.hasConversionFilter=false;q.states.step1.pageconversation_checkbox=false;q.$("#conversion_filter").prop("checked",false);q.$("#accordion1").accordion({active:false});q.setConversionPage()}q.initCheckbox();q.states.step4.camp_status=u.status;q.states.step4.sch_date=u.scheduledDate;q.app.showLoading(false,q.$el.parents(".ws-content"))})},initHeader:function(){var r=$('<a class="icon preview showtooltip" data-original-title="Preview Campaign"></a>');var t=$('<a class="icon edit showtooltip" data-original-title="Edit Campaign"></a>');var u=$('<a class="icon copy showtooltip" data-original-title="Copy Campaign"></a>');var n=$('<a class="icon delete showtooltip" data-original-title="Delete Campaign"></a>');var p=this.$el.parents(".ws-content");var s=p.find(".camp_header .edited  h2");var v=$('<div class="pointy"></div>")');v.append(t);v.append(u);v.append(r);s.append(v);p.find(".camp_header").addClass("heighted-header");p.find("#header_wp_field").attr("placeholder","Type in Campaign Name");p.find("#save_campaign_btn").click(_.bind(this.saveCampaign,this));p.find("#cancel_campaign_btn").click(_.bind(this.setupCampaign,this));p.find(".camp_header .addtag a").addClass("showtooltip");p.find("#header_wp_field").keyup(function(w){if(w.keyCode==13){p.find("#save_campaign_btn").click()}});var o=this;var q=o.app.messages[0];t.click(function(w){p.find(".camp_header .c-name h2,#campaign_tags").hide();var x=p.find("#workspace-header").html();p.find(".camp_header .c-name .edited ").show();p.find("#header_wp_field").focus().val(x);w.stopPropagation()});u.click(function(w){o.copyCamp()});p.find("#workspace-header").click(function(w){p.find(".camp_header .c-name h2,#campaign_tags").hide();var x=p.find("#workspace-header").html();p.find(".camp_header .c-name .edited ").show();p.find("#header_wp_field").focus().val(x);w.stopPropagation()});r.click(function(A){p.find(".camp_header .c-name h2,#campaign_tags").hide();var z=p.find("#workspace-header").html();if(o.states.step2.htmlText!==""){var y=$(document.documentElement).width()-60;var C=$(document.documentElement).height()-182;var x=o.app.showDialog({title:"Campaign Preview of &quot;"+z+"&quot;",css:{width:y+"px","margin-left":"-"+(y/2)+"px",top:"10px"},headerEditable:false,headerIcon:"dlgpreview",bodyCss:{"min-height":C+"px"},buttons:{saveBtn:{text:"Email Preview",btnicon:"copycamp"}}});var w="https://"+o.app.get("preview_domain")+"/pms/events/viewcamp.jsp?cnum="+o.camp_id+"&html=Y&original=N";var B=$('<iframe class="email-iframe" style="height:'+C+'px" frameborder="0" src="'+w+'"></iframe>');x.getBody().html(B);x.saveCallBack(_.bind(o.sendTextPreview,o,o.camp_id))}A.stopPropagation()});var o=this;n.click(function(){o.app.showAlertDetail({heading:"Confirm Deletion",detail:q.CAMPS_delete_confirm_error,callback:_.bind(function(){o.$el.parents(".ws-content.active").find(".overlay").remove();o.deleteCampaign(o.camp_id)},o)},o.$el.parents(".ws-content.active"))});p.find(".camp_header .showtooltip").tooltip({placement:"bottom",delay:{show:0,hide:0},animation:false})},sendTextPreview:function(n){var r=this;var p=650;var s=100;var o=r.app.showDialog({title:"Email Preview",css:{width:p+"px","margin-left":"-"+(p/2)+"px",top:"20%"},headerEditable:false,headerIcon:"copycamp",bodyCss:{"min-height":s+"px"},buttons:{saveBtn:{text:"Send",btnicon:"copycamp"}}});var q='<div style=" min-height:100px;"  class="clearfix template-container gray-panel" id="create-template-container">';q+='<div class="cont-box" style="margin-top:10px; top:0; left:56%; width:90%;">';q+='<div class="row campname-container">';q+='<label style="width:10%;">To:</label>';q+='<div class="inputcont" style="text-align:right;">';q+='<input type="text" name="_email" id="send_email" placeholder="Enter comma separated email addresses" style="width:83%;" />';q+="</div></div></div></div>";q=$(q);o.getBody().html(q);q.find("#send_email").focus();q.find("#send_email").keydown(_.bind(function(t){if(t.keyCode==13){this.sendTestCampaign(o,n)}},this));o.saveCallBack(_.bind(this.sendTestCampaign,this,o,n))},sendTestCampaign:function(q,o){var s=this;var p=q.$el.find("#send_email").val();if(p){var r={toEmails:p};this.app.showLoading("Sending Email...",q.$el);var s=this;var n="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+this.app.get("bms_token")+"&campNum="+o+"&type=email";$.post(n,r).done(function(u){var t=jQuery.parseJSON(u);s.app.showLoading(false,q.$el);if(t[0]!=="err"){q.hide();s.app.showMessge("Email sent successfully!")}else{s.app.showAlert(t[1],$("body"),{fixed:true})}})}},getcampaigns:function(){var o=this;this.app.getData({URL:"/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=listNormalCampaigns&offset=0",key:"campaigns"});var n=o.app.messages[0];o.app.showMessge(n.CAMP_copy_success_msg)},copyCamp:function(){var o=this;var p="Copy Campaign";var n=this.app.showDialog({title:p,css:{width:"600px","margin-left":"-300px"},bodyCss:{"min-height":"260px"},headerIcon:"copycamp",buttons:{saveBtn:{text:"Create Campaign"}}});this.app.showLoading("Loading...",n.getBody());require(["copycampaign"],function(q){var r=new q({camp:o,camp_id:o.camp_id,app:o.app,copycampdialog:n});n.getBody().html(r.$el);n.saveCallBack(_.bind(r.copyCampaign,r))})},deleteCampaign:function(o){var q=this;var p=this.$el.parents(".ws-content");var n="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+q.app.get("bms_token");q.app.showLoading("Deleting Campaign...",q.$el.parents(".ws-content.active"));$.post(n,{type:"delete",campNum:q.camp_id}).done(function(s){var r=jQuery.parseJSON(s);if(q.app.checkError(r)){return false}if(r[0]!=="err"){q.app.showMessge("Campaign Deleted");p.find(".camp_header .close").click()}q.app.showLoading(false,q.$el.parents(".ws-content.active"))})},initStepCall:function(n){if(this.camp_id!==0){switch(n){case"step_2":this.initStep2();break;case"step_3":this.initStep3();break;case"step_4":this.initStep4();break;default:break}}},initStep2:function(){if(this.states.step2.htmlText){this.setEditor();tinyMCE.get("bmseditor_"+this.wp_id).setContent(this.app.decodeHTML(this.states.step2.htmlText,true))}},initStep3:function(){if(this.states.step3.recipientType){var n="choose_lists";if(this.states.step3.recipientType.toLowerCase()=="list"){n="choose_lists"}else{if(this.states.step3.recipientType.toLowerCase()=="target"){n="choose_targets"}else{if(this.states.step3.recipientType.toLowerCase()=="tags"){n="choose_tags"}else{if(this.states.step3.recipientType.toLowerCase()=="salesforce"){n="salesforce_import"}else{if(this.states.step3.recipientType.toLowerCase()=="netsuite"){n="netsuite_import"}}}}}this.$(".step3 #"+n).click()}},fetchServerTime:function(){this.app.showLoading("Loading Calender...",this.$(".schedule-box > div"));var n="/pms/io/getMetaData/?type=time&BMS_REQ_TK="+this.app.get("bms_token");jQuery.getJSON(n,_.bind(function(r,p,q){if(q&&q.responseText){var o=jQuery.parseJSON(q.responseText);if(this.app.checkError(o)){return false}this.loadCalender(o[0])}},this))},loadCalender:function(p){this.app.showLoading(false,this.$(".schedule-box > div"));var q=m(this.app.decodeHTML(p),"YYYY-M-D H:m");this.createCalender(new Date(q.format("MMMM DD, YYYY HH:mm")));this.states.step4.datetime.day=this.states.step4.cal.today.getDate();this.states.step4.datetime.month=this.states.step4.cal.today.getMonth()+1;this.states.step4.datetime.year=this.states.step4.cal.today.getFullYear();var n=this.states.step4.cal.today.getHours();var o=this.states.step4.cal.today.getMinutes();if(n>=12){var n=n-12;this.$(".timebox-hours button.pm").addClass("active")}else{this.$(".timebox-hours button.am").addClass("active")}n=n==0?"12":n;this.$(".timebox-hour").spinner({max:12,min:1,start:function(r,s){}});this.$(".timebox-min").spinner({max:59,min:0,stop:function(r,s){if($(this).val().length==1){$(this).val("0"+$(this).val())}}});this.$(".timebox-hour").val(n);this.$(".timebox-min").val(o.toString().length==1?("0"+o):o)},initStep4:function(){if(this.states.step4.init===false){this.$("#accordion_info").accordion({collapsible:false,heightStyle:"fill"});this.$("#accordion_recipients").accordion({collapsible:false});if(this.states.step4.camp_status=="S"){this.loadCalender(this.states.step4.sch_date);this.showScheduleBox()}else{this.fetchServerTime()}this.$(".gotostep3").click(_.bind(function(){this.wizard.back()},this));this.$(".gotostep2").click(_.bind(function(){this.wizard.back();this.wizard.back()},this));this.$(".gotostep1").click(_.bind(function(){this.wizard.back();this.wizard.back();this.wizard.back()},this));this.states.step4.init=true}this.setScheduleArea();this.$("#campaign_preview_subject").html(this.$("#campaign_subject").val());this.$("#campaign_preview_fromEmail").html(this.app.encodeHTML(this.$("#campaign_from_email").val()));if(this.$("#fromemail_default").val()!=""&&this.$("#campaign_from_email_default").css("display")=="block"){this.$("#femail_default").show();this.$("#campaign_preview_fromEmail_default").html(this.app.encodeHTML(this.$("#fromemail_default").val()))}this.$("#campaign_preview_defaultSenderName").html(this.app.encodeHTML(this.$("#campaign_from_name").val()));if(this.$("#campaign_default_from_name").val()!=""){this.$("#fromname_default").show();this.$("#campaign_preview_sendername_default").html(this.$("#campaign_default_from_name").val())}this.$("#campaign_preview_defaultReplyTo").html(this.app.encodeHTML(this.$("#campaign_reply_to").val()));if(this.$("#campaign_default_reply_to").val()!=""){this.$("#replyto_default").show();this.$("#campaign_preview_replyto_default").html(this.$("#campaign_default_reply_to").val())}var s=this.$(".step1-settings .inputlabel");var t="",r="";$.each(s,function(){if($(this).find("input").attr("id")!=="campaign_isFooterText"){if($(this).find("input").prop("checked")){t+='<div  class="row fluidlabel"><label class="checked">'+$(this).find("label").text()+"</label></div>"}}});if(this.$("#campaign_isFooterText").prop("checked")){t+='<div class="row fluidlabel" style="margin:15px 0 0;"><label class=""><strong>Company and Physical Address in email footer:</strong></label>';t+=' <p class="clearfix">'+this.$("#campaign_footer_text").val()+"</p>";t+="</div>"}var q=this;r='<div  class="row fluidlabel"><label class="checked">Selected Recipient Type is "'+this.states.step3.recipientType+'"</label></div>';this.$(".recipients-inner").html(r);this.$(".settings-inner").html(t+"<div class='clearfix'></div>");var o=0;this.$(".step1 .socialbtns li").each(function(){var u=$(this).find("input").prop("checked");if(u){q.$(".step4 .socialbtns li."+$(this)[0].className).show();o++}else{q.$(".step4 .socialbtns li."+$(this)[0].className).hide()}});if(o==0){this.$(".social_accord").hide()}else{this.$(".social_accord").show()}if(this.$("#campaign_add_to_salesforce").prop("checked")){this.$(".sf-camp-info").show();this.$(".sf-camp-info .text").html('<img width="18" title="Salesforce" src="img/sficon.png" alt="" class="left"/> &nbsp;&nbsp;'+this.$("#sf_campaigns_combo option:selected").text())}else{this.$(".sf-camp-info").hide()}if(this.$("#conversion_filter").prop("checked")){this.$(".conversion-page-info").show();var p=this.$("#con_filter_combo").val()=="ct"?"Contains":"Equal to";this.$(".conversion-page-info .text").html("Text in URL <strong>"+p+" "+this.$("#con_filter_field").val()+"</strong>")}else{this.$(".conversion-page-info").hide()}if(this.$("#campaign_add_to_salesforce").prop("checked")||this.$("#conversion_filter").prop("checked")){this.$(".other_accord").show()}else{this.$(".other_accord").hide()}var n="https://"+q.app.get("preview_domain")+"/pms/events/viewcamp.jsp?cnum="+this.camp_id+"&html=Y&original=N";this.$("#email-preview").attr("src",n)},setScheduleArea:function(){if(this.states.step4.camp_status!=="D"){this.$(".draft-campaign").show();this.$(".scheduled-campaign").show()}else{this.$(".draft-campaign").hide();this.$(".scheduled-campaign").show()}},setupCampaign:function(){var n=this.$el.parents(".ws-content");if(this.camp_id===0){n.find(".camp_header .c-name h2,.camp_header  #campaign_tags").hide();n.find(".camp_header .c-name .edited ").show();n.find("#camp_tags").children().remove();n.find("#header_wp_field").focus().val("");n.find("#campMenu").prop("disabled",false)}else{n.find(".camp_header .c-name .edited").hide();n.find(".camp_header .c-name h2,.camp_header  #campaign_tags").show();n.find("#header_wp_field").focus().attr("process-id",this.camp_id);n.find(".step-contents").find("input,select,textarea").prop("disabled",false);this.setFooterArea();this.setSalesForceCombo();this.setConversionPage()}},saveCampaign:function(p){var o=this;var q=$(p.target).parents(".edited").find("input");var n="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+this.app.get("bms_token");if(q.val()!==""){if(q.attr("process-id")){$(p.target).addClass("saving");$.post(n,{type:"newName",campName:q.val(),campNum:this.camp_id}).done(function(s){var r=jQuery.parseJSON(s);if(r[0]!=="err"){o.$el.parents(".ws-content").find("#workspace-header").html(q.val());o.setupCampaign();o.app.showMessge("Campaign Renamed");o.app.removeCache("campaigns")}else{o.app.showAlert(r[1],o.$el.parents(".ws-content.active"))}$(p.target).removeClass("saving")})}else{$(p.target).addClass("saving");$.post(n,{type:"create",campName:q.val()}).done(function(v){var u=jQuery.parseJSON(v);if(u[0]!=="err"){o.$el.parents(".ws-content").find("#workspace-header").html(q.val());o.camp_id=u[1];var s=o.$el.parents(".ws-content");var r=s.find(".camp_header #campaign_tags");if(r.data("tags")){r.data("tags").setObjectId("campNum",u[1])}o.setupCampaign();o.app.showMessge("Campaign Created");var t=o.$el.parents(".ws-content").attr("id").split("_")[1];$("#wp_li_"+t).attr("workspace_id","campaign_"+u[1]);o.app.removeCache("campaigns")}else{o.app.showAlert(u[1],o.$el.parents(".ws-content.active"))}$(p.target).removeClass("saving")})}}p.stopPropagation()},saveStep1:function(){var o=this;var r=o.app;var v=-1;var w="";var A=true;var p=o.$el;var q="",z="";var n=p.find("#campaign_reply_to").val();var x=p.find("#campaign_default_reply_to").val();var t=new RegExp("{{[A-Z0-9_-]+(?:(\\.|\\s)*[A-Z0-9_-])*}}","ig");if(p.find("#campaign_subject").val()==""){r.showError({control:p.find(".subject-container"),message:o.app.messages[0].CAMP_subject_empty_error});A=false}else{if(p.find("#campaign_subject").val().length>100){r.showError({control:p.find(".subject-container"),message:o.app.messages[0].CAMP_subject_empty_error});A=false}else{r.hideError({control:p.find(".subject-container")})}}if(p.find("#campaign_from_name").val()==""){r.showError({control:p.find(".fname-container"),message:o.app.messages[0].CAMP_fromname_empty_error});A=false}else{r.hideError({control:p.find(".fname-container")})}if(this.$("#campaign_from_name_default").css("display")=="block"&&this.$("#campaign_default_from_name").val()==""){r.showError({control:p.find(".fnamedefault-container"),message:o.app.messages[0].CAMP_defaultfromname_empty_error});A=false}else{r.hideError({control:p.find(".fnamedefault-container")})}if(n!==""&&!t.test(n)&&!r.validateEmail(n)){r.showError({control:p.find(".replyto-container"),message:o.app.messages[0].CAMP_replyto_format_error});A=false}else{r.hideError({control:p.find(".replyto-container")})}if(p.find("#campaign_reply_to_default").css("display")=="block"&&x==""){r.showError({control:p.find(".replyemail-container"),message:o.app.messages[0].CAMP_defaultreplyto_empty_error});A=false}else{if(p.find("#campaign_reply_to_default").css("display")=="block"&&!r.validateEmail(x)){r.showError({control:p.find(".replyemail-container"),message:o.app.messages[0].CAMP_defaultreplyto_format_error});A=false}else{r.hideError({control:p.find(".replyemail-container")})}}if(!A){v=0}else{t=new RegExp("{{[A-Z0-9_-]+(?:(\\.|\\s)*[A-Z0-9_-])*}}","ig");q=t.test(this.$("#campaign_from_name").val())?this.$("#campaign_default_from_name").val():"";t=new RegExp("{{[A-Z0-9_-]+(?:(\\.|\\s)*[A-Z0-9_-])*}}","ig");z=t.test(this.$("#campaign_reply_to").val())?this.$("#campaign_default_reply_to").val():"";t=new RegExp("{{[A-Z0-9_-]+(?:(\\.|\\s)*[A-Z0-9_-])*}}","ig");var y=this.$("#campaign_from_email").val();var s=t.test(y)?this.$("#fromemail_default").val():"";if(v!==0&&(this.states.step1.change||this.camp_id==0)){this.app.showLoading("Saving Step 1...",this.$el.parents(".ws-content"));var u="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+this.app.get("bms_token");$.post(u,{type:"saveStep1",campNum:this.camp_id,subject:this.$("#campaign_subject").val(),senderName:this.$("#campaign_from_name").val(),fromEmail:y,defaultFromEmail:s,defaultSenderName:q,replyTo:this.$("#campaign_reply_to").val(),defaultReplyToEmail:z,tellAFriend:this.$("#campaign_tellAFriend")[0].checked?"Y":"N",subInfoUpdate:this.$("#campaign_profileUpdate")[0].checked?"Y":"N",unsubscribe:this.$("#campaign_unSubscribeType").val(),provideWebVersionLink:this.$("#campaign_isWebVersion")[0].checked?"Y":"N",isCampaignText:"N",isFooterText:this.$("#campaign_isFooterText")[0].checked?"Y":"N",footerText:this.$("#campaign_footer_text").val(),useCustomFooter:this.$("#campaign_useCustomFooter")[0].checked?"Y":"N",isShareIcons:this.$("#campaign_socail_share input[type='checkbox']:checked").length?"Y":"N",facebookShareIcon:this.$("#campaign_fb")[0].checked?"Y":"N",twitterShareIcon:this.$("#campaign_twitter")[0].checked?"Y":"N",linkedInShareIcon:this.$("#campaign_linkedin")[0].checked?"Y":"N",googlePlusShareIcon:this.$("#campaign_gplus")[0].checked?"Y":"N",pinterestShareIcon:this.$("#campaign_pintrest")[0].checked?"Y":"N"}).done(function(C){var B=jQuery.parseJSON(C);o.app.showLoading(false,o.$el.parents(".ws-content"));if(B[0]!=="err"){o.app.showMessge("Step 1 saved successfully!");o.states.step1.change=false;o.wizard.next()}else{o.app.showMessge(B[0])}});v=1}}return v},saveStep2:function(p){var r=this;var q=-1;var o=this.$(".step2 #choose_soruce li.selected").attr("id")!=="html_code"?tinyMCE.get("bmseditor_"+this.wp_id).getContent():this.$("textarea#myhtml").val();if(o==""&&this.states.step2.htmlText!==""){o=this.states.step2.htmlText}if(this.states.editor_change===true||typeof(p)!=="undefined"){if(typeof(p)==="undefined"){this.app.showLoading("Saving Step 2...",this.$el.parents(".ws-content"))}var n="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+this.app.get("bms_token");$.post(n,{type:"saveStep2",campNum:this.camp_id,htmlCode:o}).done(function(t){var s=jQuery.parseJSON(t);r.app.showLoading(false,r.$el.parents(".ws-content"));r.bmseditor.$el.find(".saving").removeClass("saving");if(s[0]!=="err"){r.app.showMessge("Step 2 saved successfully!");r.states.step2.htmlText=o;r.states.editor_change=false;if(typeof(p)=="undefined"){r.wizard.next()}}else{r.app.showMessge(s[0])}});q=1}return q},saveStep3:function(){if(this.states.step3.change===false){return -1}var r=this.$(".step3 #choose_soruce li.selected").attr("id");if(r=="upload_csv"){this.saveCSVUpload()}else{if(r=="choose_lists"){var n=this.saveLists();if(!n){return false}this.step3SaveCall({recipientType:"List",listNum:n})}else{if(r=="choose_targets"){var o=this.saveTargets();if(!o){return false}this.step3SaveCall({recipientType:"Target",filterNumber:o})}else{if(r=="choose_tags"){var q=this.states.step3.tags;var p=q.saveTags();if(!p){this.app.showAlert("Please select tag(s) to set recipients",$("body"),{fixed:true});return false}this.step3SaveCall({recipientType:"Tags",tags:p})}else{if(r=="salesforce_import"){this.step3SaveCall({recipientType:"Salesforce"})}else{if(r=="netsuite_import"){this.step3SaveCall({recipientType:"Netsuite"})}else{this.app.showAlert("We are not currently supporting Tags",$("body"))}}}}}}return 1},step3SaveCall:function(o){var p=this;var n="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+this.app.get("bms_token");var q="";var r={type:"recipientType",campNum:this.camp_id};if(o){$.each(o,function(s,t){r[s]=t})}this.app.showLoading("Saving Step 3",this.$el.parents(".ws-content"));$.post(n,r).done(function(t){var s=jQuery.parseJSON(t);p.app.showLoading(false,p.$el.parents(".ws-content"));if(s[0]!=="err"){p.states.step3.recipientType=r.recipientType;p.states.step3.change=false;p.app.showLoading(false,p.$el.parents(".ws-content"));if(p.states.step3.recipientType=="Salesforce"){p.saveSalesForceDetails(true)}else{if(p.states.step3.recipientType=="Netsuite"){p.saveNetSuiteDetails(true)}else{p.wizard.next();p.app.showMessge("Step 3 saved successfully!")}}}else{p.app.showMessge(s[0])}})},saveStep4:function(){return -1},initCampaignTag:function(o){var p=this.$el.parents(".ws-content");var n=p.find(".camp_header #campaign_tags");n.tags({app:this.app,url:"/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+this.app.get("bms_token"),tags:o,showAddButton:(this.camp_id=="0")?false:true,params:{type:"tags",campNum:this.camp_id,tags:""},typeAheadURL:"/pms/io/user/getData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=allCampaignTags"})},loadDataAjax:function(){var o=this;var n="/pms/io/user/getData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=campaignDefaults";jQuery.getJSON(n,function(q,r,x){if(x&&x.responseText){var w=jQuery.parseJSON(x.responseText);if(o.app.checkError(w)){return false}o.$("#campaign_footer_text").val(o.app.decodeHTML(w.footerText));o.$("#campaign_from_email").val(o.app.decodeHTML(w.fromEmail));o.$("#campaign_from_name").val(o.app.decodeHTML(w.fromName));var y=w.fromEmail;if(w.optionalFromEmails){y+=","+w.optionalFromEmails}var u=y.split(",");var s="";for(var v=0;v<u.length;v++){if(u[v]==w.fromEmail){s+='<option value="'+u[v]+'" selected="selected">'+u[v]+"</option>"}else{s+='<option value="'+u[v]+'">'+u[v]+"</option>"}}o.$el.find("#campaign_from_email").append(s);o.$el.find("#fromemail_default").append(s);o.$("#campaign_from_email").trigger("chosen:updated");o.$("#fromemail_default").trigger("chosen:updated");var t=o.$el.find("#campaign_subject").width();o.$el.find("#campaign_from_email_chosen").width(parseInt(t-40));if(w.customFooter==""){o.$("#campaign_useCustomFooter_div").hide()}else{o.$("#campaign_useCustomFooter_div").show();o.$("#campaign_custom_footer_text").val(o.app.decodeHTML(w.customFooter,true))}}}).fail(function(){console.log("error in detauls")});this.app.getData({URL:"/pms/io/salesforce/getData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=status",key:"salesfocre",callback:_.bind(this.showSalesForceArea,this)});n="/pms/io/getMetaData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=merge_tags";jQuery.getJSON(n,function(u,r,s){if(s&&s.responseText){var t=jQuery.parseJSON(s.responseText);if(o.app.checkError(t)){return false}o.mergeTags.basic=[];o.mergeTags.custom=[];o.mergeTags.salesRep=[];o.mergeTags.links=[];$.each(t,function(v,w){if(w[2]=="B"){o.mergeTags.basic.push(w)}else{if(w[2]=="C"){o.mergeTags.custom.push(w)}else{if(w[2]=="S"){o.mergeTags.salesRep.push(w)}else{if(w[2]=="U"){o.mergeTags.links.push(w)}}}}});$.each(o.mergeTags.salesRep,function(v,w){o.allMergeTags.push({type:"Sales Rep",name:w[1],code:w[0]})});$.each(o.mergeTags.basic,function(v,w){o.allMergeTags.push({type:"Basic Field",name:w[1],code:w[0]})});$.each(o.mergeTags.custom,function(v,w){o.allMergeTags.push({type:"Custom Field",name:w[1],code:w[0]})});$.each(o.mergeTags.links,function(v,w){o.allMergeTags.push({type:"Links",name:w[1],code:w[0]})});o.allMergeTags.sort(function(x,v){var w=x.name,y=v.name;if(w==y){return 0}return w>y?1:-1});var q="<ul>";$.each(o.allMergeTags,function(v,w){q+="<li mergeval='"+w.code+"' rel='"+w.type+"'><span>"+w.type+"</span><div>"+w.name+"</div><a class='search-merge-insert'>Insert</a></li>"});q+="</ul>";$(".searchfields .searchlist").html(q);$(".search-merge-insert").click(function(){var z=$(".ws-content.active");var x=$(this).parents("li").attr("mergeval");var w=$(this).parents(".mergefields").attr("input-source");if(w!=="campaign_subject"){z.find("#"+w).val(x)}else{var y=z.find("#"+w)[0].selectionStart;var v=z.find("#"+w).val();z.find("#"+w).val(v.substring(0,y)+x+v.substring(y))}z.find("#"+w+"_default").fadeIn("fast");$(".mergefields").hide()})}}).fail(function(){console.log("error merge fields json")});$(".mergefields").click(function(q){q.stopPropagation()});var p=$(".ws-tabs li").length-1},showSalesForceArea:function(){var n=this.app.getAppData("salesfocre");if(n&&n.isSalesforceUser=="Y"){this.$("#add_result_salesforce").show()}else{this.$("#add_result_salesforce").hide()}},createListTable:function(q){var p=this;this.$el.find("#recpcount span").text("0");this.$el.find("#target-lists").children().remove();var n=this.app.getAppData("lists");p.$el.find("#area_choose_lists #target-lists .bmsgrid").remove();p.$el.find("#area_choose_lists .col2 .bmsgrid").remove();p.$el.find("#area_choose_lists").removeData("mapping");var o='<table cellpadding="0" cellspacing="0" width="100%" id="list_grid"><tbody>';p.$el.find(".list-count").html("Displaying <b>"+n.count+"</b> lists");$.each(n.lists[0],function(r,s){o+='<tr id="row_'+s[0]["listNumber.encode"]+'" checksum="'+s[0]["listNumber.checksum"]+'">';o+='<td><div class="name-type"><h3>'+s[0].name+'</h3><div class="tags tagscont">'+p.app.showTags(s[0].tags)+"</div></div></td>";o+='<td><div class="subscribers show" style="min-width:70px;"><strong><span><em>Subscribers</em>'+s[0].subscriberCount+'</span></strong></div><div id="'+s[0]["listNumber.encode"]+'" class="action"><a class="btn-green add move-row"><span>Use</span><i class="icon next"></i></a></div></td>';o+="</tr>"});o+="</tbody></table>";this.$el.find("#target-lists").html(o);this.$el.find("#list_grid").bmsgrid({useRp:false,resizable:false,colresize:false,height:this.app.get("wp_height")-122,usepager:false,colWidth:["100%","90px"]});this.$("#list_grid tr td:first-child").attr("width","100%");this.$("#list_grid tr td:last-child").attr("width","90px");this.$("#recipients-list").css("height",this.app.get("wp_height")-122);this.$el.find(".taglink").click(_.bind(function(r){p.app.initSearch(r,this.$el.find("#list-search"))},this));this.$el.find("#area_choose_lists").mapping({gridHeight:this.app.get("wp_height")-122,sumColumn:"subscribers",sumTarget:"recpcount span",loadTarget:""});this.app.showLoading(false,p.$el.find("#area_choose_lists .leftcol"));if(this.states.step3.recipientType.toLowerCase()=="list"){this.setRecipients()}},setSalesForceStep1:function(n){if(n.prop("checked")){this.states.step1.sf_checkbox=true;this.$("#campaign_add_to_salesforce").prop("checked",this.states.step1.sf_checkbox);if(this.states.saleforce_campaigns===null){this.showSalesForceCampaigns()}this.$("#accordion").accordion({active:0})}else{this.removeResultFromSF();this.states.step1.sf_checkbox=false;this.$("#campaign_add_to_salesforce").prop("checked",this.states.step1.sf_checkbox);this.$("#accordion").accordion({active:false})}this.setSalesForceCombo()},setCoversionPageStep1:function(n){if(n.prop("checked")){this.states.step1.pageconversation_checkbox=true;this.$("#conversion_filter").prop("checked",this.states.step1.pageconversation_checkbox);this.$("#accordion1").accordion({active:0})}else{this.removeConversionPage();this.states.step1.pageconversation_checkbox=false;this.$("#conversion_filter").prop("checked",this.states.step1.pageconversation_checkbox);this.$("#accordion1").accordion({active:1})}this.setConversionPage()},createTargetsTable:function(){var p=this;this.$el.find("#trecpcount span").text("0");this.$el.find("#targets").children().remove();var n=this.app.getAppData("targets");p.$el.find("#area_choose_targets #targets .bmsgrid").remove();p.$el.find("#area_choose_targets .col2 .bmsgrid").remove();p.$el.find("#area_choose_targets").removeData("mapping");if(n.filters){var o='<table cellpadding="0" cellspacing="0" width="100%" id="targets_grid"><tbody>';$.each(n.filters[0],function(r,s){o+='<tr id="row_'+s[0]["filterNumber.encode"]+'" checksum="'+s[0]["filterNumber.checksum"]+'">';o+='<td><div class="name-type"><h3>'+s[0].name+'</h3><div class="tags tagscont">'+p.app.showTags(s[0].tags)+"</div></div></td>";var t=m(s[0].updationDate,"YYYY-M-D");var q=t.date()+" "+p.app.getMMM(t.month())+", "+t.year();o+='<td><div><div class="time show" style="min-width:70px;"><strong><span><em>Updation Date</em>'+q+'</span></strong></div><div id="'+s[0]["filterNumber.encode"]+'" class="action"><a class="btn-green move-row"><span>Use</span><i class="icon next"></i></a><a id="'+s[0]["filterNumber.encode"]+'" class="btn-gray edit-action"><span>Edit</span><i class="icon edit"></i></a><a id="'+s[0]["filterNumber.encode"]+'" class="btn-blue copy-action"><span>Copy</span><i class="icon copy"></i></a></div></div></td>';o+="</tr>"});o+="</tbody></table>"}this.$el.find("#targets").html(o);this.$el.find("#targets").bmsgrid({useRp:false,resizable:false,colresize:false,height:this.app.get("wp_height")-122,usepager:false,colWidth:["100%","100"]});this.$("#targets tr td:first-child").attr("width","100%");this.$("#targets tr td:last-child").attr("width","100px");this.$("#target-recipients-list").css("height",this.app.get("wp_height")-122);this.$el.find("#area_choose_targets").mapping({gridHeight:this.app.get("wp_height")-122,sumColumn:"subscribers",sumTarget:"trecpcount span",loadTarget:function(q){p.loadTarget(q)},copyTarget:function(q){p.copyTarget(q)}});this.addToCol2();this.$el.find(".taglink").click(_.bind(function(q){p.app.initSearch(q,p.$el.find("#target-search"))},p));this.$el.find("#recipients .taglink").click(_.bind(function(q){p.app.initSearch(q,p.$el.find("#target-recps-search"))},p));this.app.showLoading(false,p.$el.find("#area_choose_targets .leftcol"));if(this.states.step3.recipientType.toLowerCase()=="target"){this.setRecipients()}},addToCol2:function(o){var n=this;if(this.states.step3.isNewTarget==true){this.$("#targets").find("tr").filter(function(){if($(this).find("td h3").text().toLowerCase().indexOf(n.states.step3.newTargetName)>-1){var p=$(this).clone();$(this).remove();p.find(".action").children().hide();p.find(".move-row").removeClass("btn-green").addClass("btn-red").html('<i class="icon back left"></i><span>Remove</span>');p.find(".move-row").show();p.find(".move-row").click(_.bind(n.removeFromCol2,n));p.appendTo(n.$(".col2 .rightcol tbody"))}})}},removeFromCol2:function(p){var o=this;var n=$(p.target).parents("tr");n.fadeOut("fast",function(){var r=n.clone();$(this).remove();r.find(".action").children().show();r.find(".move-row").removeClass("btn-red").addClass("btn-green").html('<span>Use</span><i class="icon next"></i>');r.find(".move-row").click(_.bind(o.addToCol2,o));var t=r.attr("item_index");var s=null;var u=o.$el.find(".col1 .leftcol tr");for(var q=0;q<u.length;q++){if(parseInt($(u[q]).attr("item_index"))>t){s=$(u[q]);break}}if(s){r.insertBefore(s)}r.appendTo(o.$el.find(".col1 .leftcol tbody"))})},createCampaignListTable:function(){var p=this;this.app.showLoading(false,this.$("#copy-camp-listing"));this.$el.find("#copy-camp-listing").children().remove();var n=this.app.getAppData("campaigns");this.$el.find("#copy_no_of_camps .badge").html(n.totalCount);var o='<table cellpadding="0" cellspacing="0" width="100%" id="camp_list_grid"><tbody>';this.$el.find(".list-count").html("Displaying <b>"+n.count+"</b> lists");$.each(n.campaigns[0],function(v,s){var y="";var x="";if(s[0].status!="D"){y="<em>Schedule Date</em>";x=s[0].scheduledDate}else{y="<em>Updation Date</em>";if(s[0].updationDate){x=s[0].updationDate}else{x=s[0].creationDate}}var r="";if(x){var t=x.split(" ");var q=t[0].split("-");var w=p.app.getMMM(q[1].replace("0","")-1);r=q[2]+" "+w+", "+q[0]}else{r=""}var u="";if(s[0].status=="D"){u="pclr1"}else{if(s[0].status=="P"){u="pclr6"}else{if(s[0].status=="S"){u="pclr2"}else{if(s[0].status=="C"){u="pclr18"}}}}o+='<tr id="row_'+s[0]["campNum.encode"]+'">';o+='<td><div class="name-type"><div class="name-type"><h3><span class="campname" style="float:left;">'+s[0].name+'</span><span class="cstatus '+u+'">'+p.app.getCampStatus(s[0].status)+'</span></h3><div class="tags tagscont">'+p.app.showTags(s[0].tags)+"</div></div></td>";if(s[0].status!="D"){o+='<td><div class="subscribers show" style="min-width:60px"><strong><span><em>Sent</em>'+s[0].sentCount+"</span></strong></div></td>"}else{o+="<td></td>"}o+='<td><div class="time show" style="width:130px"><strong><span>'+y+r+'</span></strong></div><div id="'+s[0]["campNum.encode"]+'" class="action"><a class="btn-green"><span>Copy</span><i class="icon copy"></i></a></div></td>';o+="</tr>"});o+="</tbody></table>";this.$el.find("#copy-camp-listing").html(o);this.$el.find("#camp_list_grid").bmsgrid({useRp:false,resizable:false,colresize:false,lazyLoading:_.bind(this.appendCampaigns,this),height:"100%",usepager:false,colWidth:["100%","90px","66px","132px"]});this.$("#camp_list_grid tr td:nth-child(1)").attr("width","100%");this.$("#camp_list_grid tr td:nth-child(2)").attr("width","90px");this.$("#camp_list_grid tr td:nth-child(4)").attr("width","132px");if(n.offset&&parseInt(n.count)==parseInt(n.totalCount)){this.$("#camp_list_grid tr:last-child").removeAttr("data-load")}this.$("#copy-camp-listing .action").click(_.bind(this.copyCampaign,this));this.$el.find(".taglink").click(_.bind(function(q){p.app.initSearch(q,this.$el.find("#copy-camp-search"))},this))},appendCampaigns:function(){var o=this.app.getAppData("campaigns");if(o){var r=this;var q=o.offset?(o.offset+50):50;var p="";var n="/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=listNormalCampaigns&offset="+q;jQuery.getJSON(n,function(w,t,v){if(v&&v.responseText){var u=jQuery.parseJSON(v.responseText);if(r.app.checkError(u)){return false}var s=1;r.$("#copy-camp-listing .footer-loading").remove();o.offset=q;$.each(u.campaigns[0],function(x,y){p=$(r.makecamprows(y,true));if(s==50&&o.offset+parseInt(u.count)<parseInt(u.totalCount)){p.attr("data-load","true")}o.campaigns[0]["campaign"+(q+s)]=y;r.$("#camp_list_grid tbody").append(p);s=s+1});o.count=parseInt(o.count)+parseInt(u.count);r.$el.find(".taglink").click(_.bind(function(x){r.app.initSearch(x,r.$el.find("#list-search"))},r))}}).fail(function(){console.log("error in campaign lazy loading fields")})}else{this.getallcampaigns()}},showSalesForceCampaigns:function(){var o=this;o.app.showLoading("Loading Salesforce Campaigns...",o.$el.find("#salesforce_setup .salesforce_campaigns .template-container"));var n="/pms/io/salesforce/getData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=sfCampaignList";jQuery.getJSON(n,function(u,s,t){if(t&&t.responseText){o.app.showLoading(false,o.$el.find("#salesforce_setup .salesforce_campaigns .template-container"));var r='<select data-placeholder="Choose a Salesforce Campaign..." class="chosen-select" id="sf_campaigns_combo" >';r+='<option value=""></option>';var q=jQuery.parseJSON(t.responseText);if(o.app.checkError(q)){return false}o.states.saleforce_campaigns=q;var p='<table cellpadding="0" cellspacing="0" width="100%" id="sfcamp_list_grid"><tbody>';$.each(q.campList[0],function(v,y){var x=(o.states.step1.sfCampaignID==y[0].sfCampaignID)?"selected=selected":"";r+='<option value="'+y[0].sfCampaignID+'" '+x+">"+y[0].name+"</option>";p+='<tr id="row_'+y[0].sfCampaignID+'">';p+='<td><div class="name-type"><h3>'+y[0].name+"</h3> </td>";var w=parseFloat(y[0].contactCount)+parseFloat(y[0].leadCount);p+='<td><div><div class="subscribers show"><strong class="badge">'+w+'</strong></div><div id="'+y[0].sfCampaignID+'" class="action"><a class="btn-green select"><span>Use</span><i class="icon next"></div></div></td>';p+="</tr>"});p+="</tbody></table>";r+="</select>";o.$("#salesforce_campaigns").children().remove();o.$("#salesforce_campaigns").html(r);o.$("#salesforce-camp-listing").html(p);o.$el.find("#sfcamp_list_grid").bmsgrid({useRp:false,resizable:false,colresize:false,height:300,usepager:false,colWidth:["100%","90px"]});o.$("#sfcamp_list_grid tr td:nth-child(1)").attr("width","100%");o.$("#sfcamp_list_grid tr td:nth-child(2)").attr("width","90px");o.$("#sfcamp_list_grid .action .select").click(function(){o.$("input[name='options_sf']").eq(3).iCheck("check");o.$("#sfcamp_list_grid tr.selected").removeClass("selected");$(this).parents("tr").addClass("selected")});o.$("#sf_campaigns_combo").chosen({no_results_text:"Oops, nothing found!"});o.setSalesForceCombo();o.setSalesForceData()}}).fail(function(){console.log("error fetch sales force campaign")})},saveResultToSF:function(){var p=this;var o=this.camp_id;if(this.validateRSF()){var n="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+this.app.get("bms_token");this.$("#save_results_sf").addClass("saving");$.post(n,{campNum:o,sfCampaignID:this.$("#sf_campaigns_combo").val(),add:"Y",type:"addToSaleforce"}).done(function(q){p.$("#save_results_sf").removeClass("saving");p.states.step1.hasResultToSalesCampaign=true})}},removeResultFromSF:function(){var p=this;var o=this.camp_id;var n="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+this.app.get("bms_token");if(this.states.step1.hasResultToSalesCampaign){$.post(n,{campNum:o,add:"N",type:"addToSaleforce"}).done(function(q){p.$("#campaign_add_to_salesforce").prop("checked",false);p.states.step1.hasResultToSalesCampaign=false;p.setSalesForceCombo()})}},validateRSF:function(){var o=true;var n={top:"20%"};if(!$("#campaign_add_to_salesforce")[0].checked){o=false;this.app.showAlert('Please check "Enable Results to Salesforce campaign" checkbox',this.$(".accordion-group [id^='collapseOne']"),n)}else{if(this.camp_id=="0"){o=false;this.app.showAlert("Please select a campaign.",this.$(".accordion-group [id^='collapseOne']"),n)}else{if(this.$("#sf_campaigns_combo").val()==""){o=false;this.app.showAlert("Please select Salesforce campaign.",this.$(".accordion-group [id^='collapseOne']"),n)}}}return o},setSalesForceCombo:function(){if(this.states.step1.sf_checkbox){this.$("#sf_campaigns_combo").prop("disabled",false).trigger("chosen:updated")}else{this.$("#sf_campaigns_combo").val("").prop("disabled",true).trigger("chosen:updated")}},setConversionPage:function(){if(this.states.step1.pageconversation_checkbox){this.$("#con_filter_field").prop("disabled",false);this.$("#con_filter_combo").prop("disabled",false).trigger("chosen:updated")}else{this.$("#con_filter_field").prop("disabled",true);this.$("#con_filter_combo").prop("disabled",true).val("#").trigger("chosen:updated")}},validateConverionPage:function(){var o=true;var n={top:"20%"};if(!this.$("#conversion_filter")[0].checked){o=false;this.app.showAlert('Please check "Enable Conversion filter" checkbox.',this.$(".accordion-group [id^='collapseTwo']"),n)}else{if(this.camp_id==0){o=false;this.app.showAlert("Please select a campaign.",this.$(".accordion-group [id^='collapseTwo']"),n)}else{if(this.$("#con_filter_field").val()==""){o=false;this.app.showAlert("Please provide text in URL.",this.$(".accordion-group [id^='collapseTwo']"),n)}}}return o},saveConversionPage:function(){var p=this;var o=this.camp_id;if(this.validateConverionPage()){var n="/pms/io/filters/saveLinkIDFilter/?BMS_REQ_TK="+this.app.get("bms_token");this.$("#save_conversion_filter").addClass("saving");$.post(n,{campNum:o,rule:this.$("select#con_filter_combo").val(),matchValue:this.$("#con_filter_field").val(),type:"conversion"}).done(function(q){p.$("#save_conversion_filter").removeClass("saving");p.hasConversionFilter=true})}},removeConversionPage:function(){var p=this;var o=this.camp_id;var n="/pms/io/filters/saveLinkIDFilter/?BMS_REQ_TK="+this.app.get("bms_token");if(this.states.step1.hasConversionFilter){$.post(n,{campNum:o,type:"delete"}).done(function(q){p.$("#conversion_filter").prop("checked",false);p.states.step1.hasConversionFilter=false;p.setConversionPage()})}},showMergeFieldDialog:function(q){var v=this;if(this.camp_id==0){return false}var n=$.getObj(q,"button");var w=n.offset();var p=n.width();var r=n.height();var s=w.top+r+11;var o=w.left-$(".mergefields").width()+p+14;var u=$(".mergefields");if(u.css("display")=="block"&&parseInt(u.css("top"))==parseInt(s)){u.hide()}else{$(".mergefields .browsefields").show();$(".mergefields .browsefields #mergefields_links").hide();$(".mergefields .browsefields").removeClass("mergefields_editor");$(".mergefields .searchfields,#remove-merge-list").hide();$("#merge_list_search").val("");u.css({top:s+"px",left:o+"px"}).show();if(n.parents("div.row").find("input[type='text']")&&n.parents("div.row").find("input[type='text']").attr("id")){var t=n.parents("div.row").find("input[type='text']").attr("id")}else{if(n.parents("div.row").find("select")){var t=n.parents("div.row").find("select").attr("id")}}u.attr("input-source",t);if($(".merge-feilds-type li.active").length==0){$(".merge-feilds-type li#mergefields_basic").click()}}q.stopPropagation()},createCalender:function(y){var x=this;var q={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"},v=q[Modernizr.prefixed("transition")],t=this.$("#custom-inner"),p=this.$("#calendar"),o=p.calendario({onDayClick:function(B,A,z){if(B.hasClass("fc-disabled")===false){x.$("#calendar").find("div.selected").removeClass("selected");B.addClass("selected");x.states.step4.datetime.day=z.day;x.states.step4.datetime.month=z.month;x.states.step4.datetime.year=z.year}if(A.length>0){n(A,z)}},displayWeekAbbr:true,setDate:y}),u=this.$("#custom-month").html(o.getMonthName()+" "+o.getYear()),s=this.$("#custom-year").html("");function r(){u.html(o.getMonthName()+" "+o.getYear());s.html("")}function n(A,z){w();var C=$('<div id="custom-content-reveal" class="custom-content-reveal"><h4>Campaigns for '+z.monthname+" "+z.day+", "+z.year+"</h4></div>"),B=$('<span class="icon close custom-content-close "></span>').on("click",w);C.append(A.html(),B).insertAfter(t);setTimeout(function(){C.css("top","0%")},25)}function w(){var z=$("#custom-content-reveal");if(z.length>0){z.css("top","100%");Modernizr.csstransitions?z.on(v,function(){$(this).remove()}):z.remove()}}this.states.step4.cal=o;this.$("#custom-next").on("click",function(){o.gotoNextMonth(r)});this.$("#custom-prev").on("click",function(){o.gotoPreviousMonth(r)})},mergeFieldsSetup:function(){$(".mergefields .merge-feilds-type li").click(_.bind(this.showMergeFields,this));$(".mergefields").keyup(_.bind(this.searchMergeFields,this));$("#remove-merge-list").click(function(){$("#merge_list_search").val("");$(".mergefields .searchfields,#remove-merge-list").hide();$(".mergefields .browsefields").show();$(".mergefields  .searchfields .searchlist li").show()})},showMergeFields:function(s){var o=$.getObj(s,"li");var r=this;if(!o.hasClass("active")){var q=o.attr("id").split("_")[1];var n=this.mergeTags[q];var p="<ul id='"+q+"'>";$.each(n,function(t,u){p+="<li rel='"+q+"' mergeval='"+u[0]+"'>"+u[1]+"<a class='append-merge-field'>Insert</a></li>"});p+="</ul>";$(".browsefields .searchlist").html(p);$(".merge-feilds-type li.active").removeClass("active");o.addClass("active");$(".append-merge-field").click(function(){var x=$(".ws-content.active");var v=$(this).parents("li").attr("mergeval");var u=$(this).parents(".mergefields").attr("input-source");if(u!=="campaign_subject"){if(u=="campaign_from_email"){var y=new RegExp("{{[A-Z0-9_-]+(?:(\\.|\\s)*[A-Z0-9_-])*}}","ig");$.each(x.find("#"+u+" option"),function(){if(y.test($(this).val())){$(this).remove()}});x.find("#"+u).prepend("<option value='"+v+"'>"+v+"</option");x.find("#"+u).val(v).trigger("chosen:updated");x.find("#"+u).change()}else{x.find("#"+u).val(v)}}else{var w=x.find("#"+u)[0].selectionStart;var t=x.find("#"+u).val();x.find("#"+u).val(t.substring(0,w)+v+t.substring(w))}x.find("#"+u+"_default").fadeIn("fast");r.states.step1.change=true;$(".mergefields").hide()})}},searchMergeFields:function(s){var p=$(s.target).val();$(".mergefields .searchfields .searchlist").find(".notfound").hide();if(p.length){var r=this;$(".mergefields .searchfields,#remove-merge-list").show();$(".mergefields .browsefields").hide();$(".mergefields .searchfields .searchlist li").hide();p=p.toLowerCase();var q=0;$(".mergefields .searchfields .searchlist li").filter(function(){if($(this).find("div").text().toLowerCase().indexOf(p)>-1&&$(this).find("div").text().substring(0,9)!="<!DOCTYPE"){q++;return $(this)}}).show();var o=["Basic Field","Custom Field","Sales Rep","Links"];var n=$(".mergefields .searchfields .searchlist li");$.each(o,function(t,u){$(n).filter("li[rel='"+o[t]+"']").appendTo($(".mergefields .searchfields .searchlist ul"))});$(".mergefields .searchfields .searchlist li div").removeHighlight().highlight(p);if(q==0){$(".mergefields .searchfields .searchlist").append('<p class="notfound">No merge field found containing &lsquo;'+p+"&rsquo;</p>")}}else{$(".mergefields .searchfields .searchlist li").removeHighlight();$(".mergefields .searchfields,#remove-merge-list").hide();$(".mergefields .browsefields").show();$(".mergefields  .searchfields .searchlist li").show()}},setFooterArea:function(){this.$("#campaign_footer_text").prop("disabled",!this.$("#campaign_isFooterText")[0].checked)},step2SlectSource:function(n){var o=this;this.$(".step2 #choose_soruce li").removeClass("selected");this.$(".step2 .soruces").hide();this.$(".step2 #area_"+n.attr("id")).fadeIn("fast");n.addClass("selected");switch(n.attr("id")){case"use_template":this.loadTemplatesView();break;case"html_editor":this.setEditor();tinyMCE.get("bmseditor_"+this.wp_id).setContent(this.app.decodeHTML(this.states.step2.htmlText,true));break;case"copy_campaign":this.getallcampaigns();break;default:break}},getallcampaigns:function(){var n=this;n.app.showLoading("Loading Campaigns...",n.$("#copy-camp-listing"));if(!n.app.getAppData("campaigns")){n.app.getData({URL:"/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+n.app.get("bms_token")+"&type=listNormalCampaigns&offset=0",key:"campaigns",callback:_.bind(n.createCampaignListTable,this)})}else{window.setTimeout(_.bind(n.createCampaignListTable,this),500)}},loadTemplatesView:function(){if(!this.states.step2.templates){this.app.showLoading("Loading Templates...",this.$("#area_use_template"));var n=this;require(["bmstemplates/templates"],function(p){var o=new p({page:n,app:n.app,selectCallback:_.bind(n.selectTemplate,n)});n.$("#area_use_template").html(o.$el);o.init()});this.states.step2.templates=true}},selectTemplate:function(q){this.setEditor();var p=$.getObj(q,"a");var o=this.app.get("bms_token");this.app.showLoading("Loading HTML...",$(".fullwindow.campaign-content"));this.states.editor_change=true;var n="/pms/io/campaign/getUserTemplate/?BMS_REQ_TK="+o+"&type=html&templateNumber="+p.attr("id").split("_")[1];jQuery.getJSON(n,_.bind(this.setEditorHTML,this))},copyCampaign:function(q){this.setEditor();var p=$.getObj(q,"div");var o=this.app.get("bms_token");this.states.editor_change=true;this.app.showLoading("Loading HTML...",$(".fullwindow.campaign-content"));var n="/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+o+"&campNum="+p.attr("id")+"&type=basic";jQuery.getJSON(n,_.bind(this.setEditorHTML,this))},setEditor:function(){this.bmseditor.showEditor(this.wp_id);var n=this.$el.parents(".ws-content");n.find(".camp_header").addClass("workspace-fixed-editor");tinyMCE.get("bmseditor_"+this.wp_id).setContent("")},setEditorHTML:function(q,o,p){this.app.showLoading(false,$(".fullwindow.campaign-content"));var n=jQuery.parseJSON(p.responseText);if(n.htmlText){tinyMCE.get("bmseditor_"+this.wp_id).setContent(this.app.decodeHTML(n.htmlText,true))}},step3SlectSource:function(n){var o=this;o.checkCSVUploaded();switch(n.attr("id")){case"create_target":if(!this.$("#c_c_target").data("filters")){this.$("#c_c_target").filters({app:this.app})}else{this.$("#c_c_target").data("filters").initFilters();this.states.step3.target_id=0;this.showHideTargetTitle(true,true)}this.$("#targets_tags").tags({app:this.app,url:"/pms/io/filters/saveTargetInfo/?BMS_REQ_TK="+this.app.get("bms_token"),params:{type:"tags",filterNumber:"",tags:""}});break;case"choose_targets":if(this.checkRecipientsSaved("target")){return false}if(!this.app.getAppData("targets")){o.app.showLoading("Loading Targets...",o.$el.find("#area_choose_targets .leftcol"));this.app.getData({URL:"/pms/io/filters/getTargetInfo/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=list&filterFor=C",key:"targets",callback:_.bind(this.createTargetsTable,this)})}else{this.createTargetsTable()}break;case"choose_lists":if(this.checkRecipientsSaved("list")){return false}if(!this.app.getAppData("lists")){this.app.showLoading("Loading Lists...",o.$el.find("#area_choose_lists .leftcol"));this.app.getData({URL:"/pms/io/list/getListData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=all",key:"lists",callback:_.bind(this.createListTable,this)})}else{this.createListTable()}break;case"upload_csv":o.app.showLoading("Loading CSV upload...",o.$el.find("#area_upload_csv"));require(["listupload/csvupload"],function(p){var q=new p({camp:o,app:o.app});o.$el.find(".step3 #area_upload_csv").html(q.$el);o.states.step3.csvupload=q});break;case"salesforce_import":this.checkSalesForceStatus();break;case"netsuite_import":this.checkNetSuiteStatus();break;case"choose_tags":if(this.checkRecipientsSaved("tags")){return false}o.app.showLoading("Loading Tags...",o.$el.find("#area_choose_tags"));require(["tags"],function(q){var p=new q({camp:o,app:o.app});o.$el.find(".step3 #area_choose_tags").html(p.$el);o.states.step3.tags=p});break;default:break}this.states.step3.change=true},checkRecipientsSaved:function(n){var o=false;if(this.states.step3.recipientType.toLowerCase()==n&&this.states.step3.recipientDetial){return true}return o},checkCSVUploaded:function(){var r=this;var o=this.app.messages[0];var p=r.states.step3.csvupload;var n=r.states.step3.mapdataview;if(p&&p.fileuploaded==true){var q="/pms/io/subscriber/uploadCSV/?BMS_REQ_TK="+r.app.get("bms_token");$.post(q,{stepType:"cancel"}).done(function(t){var s=jQuery.parseJSON(t);if(s[0]=="success"){r.app.showAlert(o.CSVUpload_cancel_msg,r.$el,{type:"caution"});p.$el.find("#dropped-files").children().remove();p.$el.find("#drop-files .middle").css("display","block");p.dataArray=[];p.fileuploaded=false;p.$el.find("#drop-files").css({"box-shadow":"none",border:"1px dashed #CCCCCC"});n.$el.find("#uploadslist").children().remove();n.$el.find("#newlist").val("");n.$el.find("#alertemail").val("");r.app.showLoading(false,p.$el)}})}},createTarget:function(){var o=this;var p="New Target";var n=this.app.showDialog({title:p,css:{width:"650px","margin-left":"-325px"},bodyCss:{"min-height":"100px"},headerIcon:"new_headicon",buttons:{saveBtn:{text:"Create Target"}}});this.app.showLoading("Loading...",n.getBody());require(["target/newtarget"],function(r){var q=new r({camp:o,app:o.app,newtardialog:n});n.getBody().html(q.$el);n.saveCallBack(_.bind(q.createTarget,q))})},initCreateEditTarget:function(q){var n=this;var s=q?q:"";var r=q?"Edit Target":"";var p=$(document.documentElement).width()-60;var t=$(document.documentElement).height()-219;var o=this.app.showDialog({title:r,css:{width:p+"px","margin-left":"-"+(p/2)+"px",top:"10px"},headerEditable:true,bodyCss:{"min-height":t+"px"},headerIcon:"target_headicon",buttons:{saveBtn:{text:"Save Target"}}});this.app.showLoading("Loading...",o.getBody());require(["target/target"],function(v){var u=new v({camp:n,target_id:s,dialog:o});n.states.step3.targetDialog=u;o.getBody().html(u.$el);o.saveCallBack(_.bind(u.saveTargetFilter,u))})},copyTarget:function(s){var n=$.getObj(s,"div");var p=n.attr("id");var q=this;var r="Copy Target";var o=this.app.showDialog({title:r,css:{width:"650px","margin-left":"-325px"},bodyCss:{"min-height":"100px"},headerIcon:"copycamp",buttons:{saveBtn:{text:"Copy Target"}}});this.app.showLoading("Loading...",o.getBody());require(["target/copytarget"],function(t){var u=new t({camp:q,app:q.app,target_id:p,copydialog:o});o.getBody().html(u.$el);o.saveCallBack(_.bind(u.copyTarget,u))})},loadTarget:function(p){var n=$.getObj(p,"div");var o=n.attr("id");this.initCreateEditTarget(o)},loadTargets:function(){var n=this;n.$el.find("#trecpcount span").text("0");n.app.showLoading("Loading Targets...",n.$el.find("#area_choose_targets .leftcol"));this.app.getData({URL:"/pms/io/filters/getTargetInfo/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=list&filterFor=C",key:"targets",callback:_.bind(this.createTargetsTable,this)})},checkSalesForceStatus:function(){var o=this;var n=this.app.getAppData("salesfocre");if(!n||n[0]=="err"||n.isSalesforceUser=="N"){o.app.showLoading("Getting Salesforce Status...",o.$el.find("#area_salesforce_import"));this.app.getData({URL:"/pms/io/salesforce/getData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=status",key:"salesfocre",callback:_.bind(this.setSalesForceWiz,this)})}else{this.setSalesForceWiz()}},setSalesForceWiz:function(){var q=this;q.app.showLoading(false,q.$el.find("#area_salesforce_import"));var p=this.app.getAppData("salesfocre");var o=this;if(p&&p.isSalesforceUser=="Y"){if(this.states.saleforce_campaigns===null){this.showSalesForceCampaigns()}this.$("#salesforce_welcome").hide();this.$("#salesforce_setup").show()}else{this.$("#salesforce_welcome").show();this.$("#salesforce_setup").hide()}if(this.states.step3.recipientType.toLowerCase()=="salesforce"){this.setRecipients()}if(!this.states.step3.salesforce){this.$("#sf_accordion").accordion({active:0,collapsible:false});this.$("#sf_accordion h3.ui-accordion-header").unbind("keydown");o.$("#salesforce_setup .filterbtn .managefilter").click(_.bind(o.showSalesForceFitler,o));o.$("#salesforce_setup .filterbtn .selectall").click(_.bind(o.selectAllSalesforceFilter,o));this.$(".salesforce_campaigns input.radiopanel").iCheck({radioClass:"radiopanelinput",insert:'<div class="icheck_radio-icon"></div>'});this.$(".salesforce_campaigns input.radiopanel").on("ifChecked",function(s){q.$("#salesforce_setup .ui-accordion-header.selected").removeClass("selected");$(this).parents(".ui-accordion-header").addClass("selected");var r=$(this).attr("value");if(r!=="campaign"){q.$("#sfcamp_list_grid tr.selected").removeClass("selected")}});if(this.states.step3.recipientType.toLowerCase()!=="salesforce"){this.$("input[name='options_sf']").eq(0).iCheck("check")}o.$("#salesforce_setup .sf_all_count,#salesforce_setup .sf_lead_count,#salesforce_setup .sf_contact_count").addClass("loading-wheel-inline").html("");var n="/pms/io/salesforce/getData/?BMS_REQ_TK="+o.app.get("bms_token")+"&type=allCount";jQuery.getJSON(n,function(v,t,u){var s=jQuery.parseJSON(u.responseText);var r=parseFloat(s.contactCount)+parseFloat(s.leadCount);o.$("#salesforce_setup .sf_all_count").html(r).removeClass("loading-wheel-inline");o.$("#salesforce_setup .sf_contact_count").html(s.contactCount).removeClass("loading-wheel-inline");o.$("#salesforce_setup .sf_lead_count").html(s.leadCount).removeClass("loading-wheel-inline")});this.$("#salesforce-camp-search").searchcontrol({id:"salesforce-camp-search",width:"300px",height:"22px",placeholder:"Search Salesforce Campaign",gridcontainer:"sfcamp_list_grid",showicon:"yes",iconsource:"campaigns"});this.states.step3.salesforce=true;this.$("#sf_setting_menu li").click(_.bind(function(t){var r=$.getObj(t,"li");if(r.attr("id")=="sf_mapping"){var s=this.app.showDialog({title:" Specify Leads or/and Contacts to Import",css:{width:"1200px","margin-left":"-600px"},bodyCss:{"min-height":"430px"},buttons:{saveBtn:{text:"Save Mapping"}}});this.app.showLoading("Loading Mapping...",s.getBody());require(["crm/salesforce/mapping"],function(u){var v=new u({camp:o,app:q.app,dialog:s});s.getBody().html(v.$el);s.saveCallBack(_.bind(v.saveCall,v))})}else{if(r.attr("id")=="sf_user_setting"){var s=this.app.showDialog({title:"Salesforce Login Setup",css:{width:"650px","margin-left":"-325px"},bodyCss:{"min-height":"360px"}});this.app.showLoading("Loading Login...",s.getBody());require(["crm/salesforce/login"],function(u){var v=new u({camp:o,app:o.app,dialog:s});s.getBody().html(v.$el)})}}},this))}else{if(this.checkRecipientsSaved("salesforce")){return false}this.$("#sfcamp_list_grid tr.selected").removeClass("selected")}},selectAllSalesforceFilter:function(o){var n=$(o.target).parents(".ui-accordion-header").find("input.radiopanel");n.iCheck("check")},showSalesForceFitler:function(t){var s="Lead";var r=$(t.target).parents(".ui-accordion-header").find("input.radiopanel");var n=r.val();r.iCheck("check");if(n=="contact"){s="Contant"}else{if(n=="both"){s="Lead & Contact"}}var o=this;var q=$(document.documentElement).width()-60;var u=$(document.documentElement).height()-219;var p=this.app.showDialog({title:s,css:{width:q+"px","margin-left":"-"+(q/2)+"px",top:"10px"},bodyCss:{"min-height":u+"px"},buttons:{saveBtn:{text:"Save Filter"}}});this.app.showLoading("Loading Filters...",p.getBody());require(["crm/salesforce/after_filter"],function(y){var x=o.states.step3;var v=(x.recipientType&&x.recipientType.toLowerCase()=="salesforce"&&x.recipientDetial.filterType==="filter")?x.recipientDetial:null;var w=new y({camp:o,savedObject:v,type:n});w.$el.css("margin","10px 0px");p.getBody().html(w.$el);p.saveCallBack(_.bind(w.saveFilter,w,p,_.bind(o.saveFilterStep3,o)))})},setSalesForceData:function(){if(this.states.step3.recipientDetial&&this.states.step3.recipientType.toLowerCase()=="salesforce"){var n=this.states.step3.recipientDetial;if(n.filterType==="campaign"){this.$("input[name='options_sf']").eq(3).iCheck("check");this.$("#sfcamp_list_grid tr[id='row_"+n.sfCampaignId+"']").addClass("selected")}else{if(n.filterType==="filter"&&n.sfObject!=="both"){if(n.sfObject=="lead"){this.$("input[name='options_sf']").eq(1).iCheck("check")}else{if(n.sfObject=="contact"){this.$("input[name='options_sf']").eq(2).iCheck("check")}}}else{if(n.filterType=="filter"&&n.sfObject=="both"){this.$("input[name='options_sf']").eq(0).iCheck("check")}}}this.states.step3.change=false}},saveSalesForceDetails:function(v){var n=this;var p=this.$(".salesforce_campaigns input[name='options_sf']:checked").val();var q={type:"import",synchType:"recipients",campNum:this.camp_id};var t="/pms/io/salesforce/setData/?BMS_REQ_TK="+this.app.get("bms_token");if(p=="campaign"){var s=this.$("#salesforce_setup .salesforce_campaigns #sfcamp_list_grid tr.selected");if(s.length===1){q.filterType="campaign";q.sfCampaignId=s.attr("id").split("_")[1]}else{this.app.showAlert("Please select a salesforce campaign to proceed.",$("body"),{fixed:true});return false}}else{var o=p;q.filterType="filter";q.sfObject=o;var r=n.states.step3.sf_filters.lead;var u=n.states.step3.sf_filters.contact;if(o=="lead"){$.extend(q,r)}else{if(o=="contact"){$.extend(q,u)}else{if(o=="both"){$.extend(q,r);$.extend(q,u)}}}}this.app.showLoading("Saving Salesforce Settings...",this.$el.parents(".ws-content"));$.post(t,q).done(function(z){var y=jQuery.parseJSON(z);n.app.showLoading(false,n.$el.parents(".ws-content"));if(y[0]!=="err"){if(q.filterType=="campaign"||v){n.wizard.next();n.app.showMessge("Step 3 saved successfully!")}else{var x=n.$(".salesforce_campaigns .ui-accordion-header.selected .managefilter .badge");n.app.showMessge("Saleforce Filters saved successfully!");n.$(".salesforce_campaigns .ui-accordion-header .managefilter .badge").hide();var w=parseInt(y.contactCount)+parseInt(y.leadCount);x.show().html(w);n.fetchFilters("Saleforce")}}else{n.app.showAlert(y[1],$("body"),{fixed:true})}})},fetchFilters:function(o){var p=this;var n="";if(o=="Saleforce"){n="/pms/io/salesforce/getData/?BMS_REQ_TK="+this.app.get("bms_token")+"&campNum="+this.camp_id+"&type=import"}else{n="/pms/io/netsuite/getData/?BMS_REQ_TK="+this.app.get("bms_token")+"&campNum="+this.camp_id+"&type=import"}jQuery.getJSON(n,function(t,r,s){if(s&&s.responseText){var q=jQuery.parseJSON(s.responseText);if(p.app.checkError(q)){return false}if(q[0]!=="err"){p.states.step3.recipientDetial=q}}})},saveFilterStep3:function(o){var p=this;var n="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+this.app.get("bms_token");var q={type:"recipientType",campNum:this.camp_id};q.recipientType=o;this.app.showLoading("Saving "+o+" Settings...",this.$el.parents(".ws-content"));$.post(n,q).done(function(s){var r=jQuery.parseJSON(s);if(r[0]!=="err"){p.states.step3.recipientType=q.recipientType;p.states.step3.change=false;if(o=="Salesforce"){p.saveSalesForceDetails()}else{p.saveNetSuiteDetails()}}else{p.app.showMessge(r[0])}})},checkNetSuiteStatus:function(){var n=this;var o=this.app.getAppData("netsuite");if(!o||o[0]=="err"||o.isNetsuiteUser=="N"){n.app.showLoading("Getting Netsuite Status...",n.$el.find("#area_netsuite_import"));this.app.getData({URL:"/pms/io/netsuite/getData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=status",key:"netsuite",callback:_.bind(this.setNetSuiteeWiz,this)})}else{this.setNetSuiteeWiz()}},setNetSuiteeWiz:function(){var o=this;o.app.showLoading(false,o.$el.find("#area_netsuite_import"));var p=this.app.getAppData("netsuite");if(p&&p.isNetsuiteUser=="Y"){this.$("#netsuite_login,#netsuite_welcome").hide();this.$("#netsuite_setup").show()}else{this.$("#netsuite_login,#netsuite_setup").hide();this.$("#netsuite_welcome").show()}if(this.states.step3.recipientType.toLowerCase()=="netsuite"){this.setRecipients()}var n=this;if(!this.states.step3.netsuite){this.$("#ns_accordion").accordion({active:0,collapsible:false});this.$("#ns_accordion h3.ui-accordion-header").unbind("keydown");n.$("#netsuite_setup .filterbtn .managefilter").click(_.bind(n.showNetSuiteFitler,n));n.$("#netsuite_setup .filterbtn .selectall").click(_.bind(n.selectAllNetSuiteFilter,n));this.$("#netsuite_setup input.radiopanel").iCheck({radioClass:"radiopanelinput",insert:'<div class="icheck_radio-icon"></div>'});this.$(".netsuite_groups input.radiopanel").on("ifChecked",function(r){o.$("#netsuite_setup .ui-accordion-header.selected").removeClass("selected");$(this).parents(".ui-accordion-header").addClass("selected");var q=$(this).attr("value");if(q!=="campaign"){o.$("#netsuite-group-listing tr.selected").removeClass("selected")}o.states.step3.change=true});if(this.states.step3.recipientType.toLowerCase()!=="netsuite"){this.$("input[name='options_ns']").eq(0).iCheck("check")}this.$("#netsuite-group-search").searchcontrol({id:"netsuite-group-search",width:"300px",height:"22px",placeholder:"Search NetSuite Groups",gridcontainer:"nsgroup_list_grid",showicon:"yes",iconsource:"campaigns"});this.states.step3.netsuite=true;this.$("#ns_setting_menu li").click(_.bind(function(s){var q=$.getObj(s,"li");if(q.attr("id")=="ns_mapping"){var r=this.app.showDialog({title:" Specify Customers, Contacts or/and Partners to Import",css:{width:"1200px","margin-left":"-600px"},bodyCss:{"min-height":"430px"},buttons:{saveBtn:{text:"Save Mapping"}}});this.app.showLoading("Loading Mapping...",r.getBody());require(["crm/netsuite/mapping"],function(t){var u=new t({camp:n,app:o.app,dialog:r});r.getBody().html(u.$el);r.saveCallBack(_.bind(u.saveCall,u))})}else{if(q.attr("id")=="ns_user_setting"){var r=this.app.showDialog({title:"NetSuite Login Setup",css:{width:"650px","margin-left":"-325px"},bodyCss:{"min-height":"360px"}});this.app.showLoading("Loading Login...",r.getBody());require(["crm/netsuite/login"],function(t){var u=new t({camp:n,app:o.app,dialog:r});r.getBody().html(u.$el)})}}},this))}else{if(this.checkRecipientsSaved("netsuite")){return false}this.$("#nsgroup_list_grid tr.selected").removeClass("selected")}if(p&&p.isNetsuiteUser=="Y"){this.loadNetSuiteGroup()}},selectAllNetSuiteFilter:function(o){var n=$(o.target).parents(".ui-accordion-header").find("input.radiopanel");n.iCheck("check")},showNetSuiteFitler:function(t){var s="Customer";var r=$(t.target).parents(".ui-accordion-header").find("input.radiopanel");var n=r.val();r.iCheck("check");if(n=="contact"){s="Contant"}else{if(n=="partner"){s="Partner"}}var o=this;var q=$(document.documentElement).width()-60;var u=$(document.documentElement).height()-219;var p=this.app.showDialog({title:s,css:{width:q+"px","margin-left":"-"+(q/2)+"px",top:"10px"},bodyCss:{"min-height":u+"px"},buttons:{saveBtn:{text:"Save Filter"}}});this.app.showLoading("Loading Filters...",p.getBody());require(["crm/netsuite/after_filter"],function(y){var x=o.states.step3;var v=(x.recipientType&&x.recipientType.toLowerCase()=="netsuite"&&x.recipientDetial.filterType==="filter")?x.recipientDetial:null;var w=new y({camp:o,savedObject:v,type:n});w.$el.css("margin","10px 0px");p.getBody().html(w.$el);p.saveCallBack(_.bind(w.saveFilter,w,p,_.bind(o.saveFilterStep3,o)))});o.states.step3.change=true},setNetSuiteData:function(){if(this.states.step3.recipientDetial&&this.states.step3.recipientType.toLowerCase()=="netsuite"){var o=this;var n=this.states.step3.recipientDetial;if(n.filterType==="group"){this.$("input[name='options_ns']").eq(3).iCheck("check");this.$("#nsgroup_list_grid tr[id='row_"+n.nsGroupId+"']").addClass("selected")}else{if(n.filterType==="filter"){if(n.nsObject.indexOf("customer")>-1){this.$("input[name='options_ns']").eq(0).iCheck("check")}else{if(n.nsObject=="contact"){this.$("input[name='options_ns']").eq(1).iCheck("check")}else{if(n.nsObject=="partner"){this.$("input[name='options_ns']").eq(2).iCheck("check")}}}}}this.states.step3.change=false}},loadNetSuiteGroup:function(){var n=this;if(n.states.step3.netsuitegroups){return false}this.app.showLoading("Loading Groups...",n.$("#netsuite_setup .netsuite_groups .template-container"));URL="/pms/io/netsuite/getData/?BMS_REQ_TK="+this.app.get("bms_token")+"&type=nsGroupList";jQuery.getJSON(URL,function(s,p,r){n.app.showLoading(false,n.$("#netsuite_setup .netsuite_groups .template-container"));var q=jQuery.parseJSON(r.responseText);if(n.app.checkError(q)){return false}if(q[0]!=="err"){if(q.count!="0"){n.states.step3.netsuitegroups=q;var o='<table cellpadding="0" cellspacing="0" width="100%" id="nsgroup_list_grid"><tbody>';$.each(q.groupList[0],function(t,v){o+='<tr id="row_'+v[0].id+'">';o+='<td><div class="name-type"><h3>'+v[0].name+"</h3> </td>";var u=v[0].count;o+='<td><div class="subscribers show" style="min-width:70px"><span class=""></span>'+u+'</div><div id="'+v[0].id+'" class="action"><a class="btn-green use"><span>Use</span><i class="icon next"></i></a></div></td>';o+="</tr>"});o+="</tbody></table>";n.$("#netsuite-group-listing").html(o);n.$el.find("#nsgroup_list_grid").bmsgrid({useRp:false,resizable:false,colresize:false,height:300,usepager:false,colWidth:["100%","90px"]});n.$("#nsgroup_list_grid tr td:nth-child(1)").attr("width","100%");n.$("#nsgroup_list_grid tr td:nth-child(2)").attr("width","90px");n.$("#nsgroup_list_grid .action .use").click(function(){n.$("#nsgroup_list_grid tr.selected").removeClass("selected");n.$("input[name='options_ns']").eq(3).iCheck("check");$(this).parents("tr").addClass("selected")});n.setNetSuiteData()}}else{n.app.showAlert(q[1],$("body"),{fixed:true})}}).fail(function(){console.log("error net suite group listing")})},saveNetSuiteDetails:function(t){var n=this;var o=this.$(".netsuite_groups input[name='options_ns']:checked").val();var p={type:"import",synchType:"recipients",campNum:this.camp_id};var r="/pms/io/netsuite/setData/?BMS_REQ_TK="+this.app.get("bms_token");if(o=="group"){var q=this.$("#netsuite_setup .netsuite_groups #nsgroup_list_grid tr.selected");if(q.length===1){p.filterType="group";p.nsGroupId=q.attr("id").split("_")[1]}else{this.app.showAlert("Please select a netsuite group to proceed.",$("body"),{fixed:true});return false}}else{p.filterType="filter";if(n.states.step3.ns_filters.nsObject!==""){p.nsObject=n.states.step3.ns_filters.nsObject}else{p.nsObject=o}var u=n.states.step3.ns_filters.customer;var s=n.states.step3.ns_filters.contact;var v=n.states.step3.ns_filters.partner;if(o=="customer"){$.extend(p,u)}else{if(o=="contact"){$.extend(p,s)}else{if(o=="partner"){$.extend(p,v)}}}}this.app.showLoading("Saving Netsuite settings...",this.$el.parents(".ws-content"));$.post(r,p).done(function(y){n.app.showLoading(false,n.$el.parents(".ws-content"));var x=jQuery.parseJSON(y);if(x[0]!=="err"){if(p.filterType=="group"||t){n.wizard.next();n.app.showMessge("Step 3 saved successfully!")}else{var w=n.$(".netsuite_groups .ui-accordion-header.selected .managefilter .badge");n.app.showMessge("Netsuite Filters saved successfully!");n.fetchFilters("Nesuite")}}else{n.app.showAlert(x[1],$("body"),{fixed:true})}})},saveCSVUpload:function(){var p=this;var q=false;var o=p.states.step3.csvupload;var n=p.states.step3.mapdataview;if(o&&o.fileuploaded==true){o.$el.hide();p.app.showLoading(false,n.$el);q=n.mapAndImport();if(q){n.$el.hide();p.$el.find("#upload_csv").removeClass("selected")}return q}else{this.app.showAlert("Please supply csv file to upload",this.$el.parents(".ws-content"))}},saveLists:function(){var n=this.$("#area_choose_lists .col2 tr").map(function(){return $(this).attr("id").split("_")[1]}).toArray().join();if(!n){this.app.showAlert("Please select list(s) to set recipients",$("body"),{fixed:true})}return n},saveTargets:function(){var n=this.$("#area_choose_targets .col2 tr").map(function(){return $(this).attr("id").split("_")[1]}).toArray().join();if(!n){this.app.showAlert("Please select target(s) to set recipients",$("body"),{fixed:true})}return n},setRecipients:function(){var p=this;if(this.states.step3.recipientDetial){return false}this.app.showLoading("Loading Recipients...",this.$el.parents(".ws-content"));var n="";var o=p.states.step3.recipientType.toLowerCase();if(o=="salesforce"){n="/pms/io/salesforce/getData/?BMS_REQ_TK="+this.app.get("bms_token")+"&campNum="+this.camp_id+"&type=import"}else{if(o=="netsuite"){n="/pms/io/netsuite/getData/?BMS_REQ_TK="+this.app.get("bms_token")+"&campNum="+this.camp_id+"&type=import"}else{n="/pms/io/campaign/getCampaignData/?BMS_REQ_TK="+this.app.get("bms_token")+"&campNum="+this.camp_id+"&type=recipientType"}}jQuery.getJSON(n,function(v,t,u){p.app.showLoading(false,p.$el.parents(".ws-content"));if(u&&u.responseText){var s=jQuery.parseJSON(u.responseText);if(p.app.checkError(s)){return false}p.states.step3.recipientDetial=s;if(s.type){if(s.type.toLowerCase()=="list"){if(s.count!=="0"){$.each(s.listNumbers[0],function(w,x){p.$(".step3 #area_choose_lists .col1 tr[checksum='"+x[0].checksum+"'] .move-row").click()})}else{p.$el.find(".step3 #area_choose_lists .rightcol tbody").append('<div style="padding: 20px;" class="recp_empty_info"> <div style="width:auto;" class="messagebox info"><p>Don\'t worry about duplicates. only one message is sent to each email addres</p></div></div>')}}else{if(s.type.toLowerCase()=="target"){if(s.count!=="0"){$.each(s.filterNumbers[0],function(w,x){p.$(".step3 #area_choose_targets .col1 tr[checksum='"+x[0].checksum+"'] .move-row").click()})}else{p.$(".step3 #area_choose_targets .rightcol tbody").append('<div style="padding: 20px;" class="recp_empty_info"> <div style="width:auto;" class="messagebox info"><p>Don\'t worry about duplicates. only one message is sent to each email addres</p></div></div>')}}else{if(s.type.toLowerCase()=="tags"){var q=s.targetTags.split(",");for(var r=0;r<q.length;r++){p.$(".step3 #area_choose_tags .col1 li[checksum='"+q[r]+"'] .move-row").click()}}}}}else{if(o=="salesforce"){p.setSalesForceData()}else{if(o=="netsuite"){p.setNetSuiteData()}}}p.states.step3.change=false}}).fail(function(){console.log("Receipts data load failed")})},scheduledCampaign:function(t,w){var u="/pms/io/campaign/saveCampaignData/?BMS_REQ_TK="+this.app.get("bms_token");var p=this.states.step4.datetime;var y=p.year+"-"+this.addZero(p.month)+"-"+this.addZero(p.day);var x=this.$(".timebox-hour").val();var o=this.getHourForSchedule(x);o=this.addZero(o);var s=this.addZero(this.$(".timebox-min").val());var q=o+":"+s+":00";var n=this;var r={campNum:this.camp_id,type:"saveStep4",status:t};if(t=="S"){r.scheduleType="scheduled";r.scheduleDate=y+" "+q}var v=w?w:"Changing mode...";this.app.showLoading(v,this.$el.parents(".ws-content"));$.post(u,r).done(function(A){n.app.showLoading(false,n.$el.parents(".ws-content"));var z=jQuery.parseJSON(A);if(z[0]!=="err"){if(t=="S"){n.showScheduleBox();n.states.step4.camp_status="P";n.setScheduleArea();n.app.showMessge("Campaign Scheduled Successfully!")}else{n.$(".schedule-camp").show();n.$(".sch-made").hide();n.states.step4.camp_status="D";n.setScheduleArea();n.app.showMessge("Campaign is now in draft mode!")}}else{n.app.showAlert(z[1],$("body"),{fixed:true})}})},addZero:function(n){n=n.toString().length==1?"0"+n:n;return n},getHourForSchedule:function(n){if(this.$(".timebox-hours button.pm").hasClass("active")){if(parseInt(n)<=11){n=parseInt(n)+12}}else{if(parseInt(n)==12){n="00"}}return n},showScheduleBox:function(){var n=this.states.step4.datetime;this.$(".schedule-camp").hide();var o="<strong>"+this.$el.parents(".ws-content").find("#workspace-header").html()+"</strong> Has been Scheduled to be sent on";o+="<span>"+n.day+" "+this.app.getMMM(n.month-1)+" "+n.year+"</span> at <em>"+this.$(".timebox-hour").val()+":"+this.$(".timebox-min").val()+" "+this.$(".timebox-hours button.active").html()+"</em>";this.$(".camp-sch-detail").html(o);this.$(".sch-made").show()}})});